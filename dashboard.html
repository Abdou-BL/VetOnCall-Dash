<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VetOnCall Sidebar</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <link rel="stylesheet" href="dashboard.css">
    <script type="module" src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js"></script>
    <style>
        .status-badge.normal {
            background-color: #dcfce7;
            color: #166534;
        }

        .status-badge.grave {
            background-color: #fee2e2;
            color: #991b1b;
        }
        
        .day-schedule-modal {
            width: 90% !important;
            max-width: 600px !important;
            padding: 20px;
        }
        
        .day-schedule {
            max-height: 70vh;
            overflow-y: auto;
            padding: 10px;
        }
        
        .hour-slot {
            display: flex;
            margin-bottom: 10px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        
        .time-label {
            width: 100px;
            color: #05867C;
            font-weight: 500;
            font-size: 0.9rem;
        }
        
        .time-slot {
            flex: 1;
            min-height: 40px;
            border-left: 2px solid #05867C;
            padding-left: 15px;
        }
        
        .slot-content {
            padding: 8px;
            min-height: 30px;
        }
        
        .calendar-day {
            cursor: pointer;
        }
        
        .appointment-card .time {
            font-size: 0.85rem;
            color: #64748b;
            margin-bottom: 3px;
        }
        
        .appointment-card .name {
            font-size: 0.9rem;
            font-weight: bold;
            color: #05867C;
            margin-bottom: 2px;
            margin-right: 10px;
        }
        
        .appointment-card .pet {
            font-size: 0.8rem;
            color: #64748b;
            margin-bottom: 2px;
        }
        
        .appointment-card .details {
            display: flex;
            align-items: center;
            margin-top: 4px;
            font-size: 0.8rem;
        }

        .details .status-badge {
            font-size: 0.75rem !important;
            padding: 2px 8px;
        }

        .appointment-card {
            background: #f8f9fa;
            border-radius: 4px;
            padding: 8px;
            margin-bottom: 6px;
            font-size: 0.8rem;
            border-left-width: 3px;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        
        .appointment-counts {
            display: flex;
            justify-content: space-between;
            margin: 3px 0;
            font-size: 0.6rem;
            gap: 2px;
        }

        .appointment-counts .status-badge {
            padding: 1px 6px;
            border-radius: 4px;
            font-size: 0.6rem;
        }

        .status-badge {
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .schedule-day {
            min-height: 100px;
            background: white;
            border-radius: 6px;
            padding: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.03);
            position: relative;
            border: 1px solid #e2e8f0;
            transition: all 0.2s ease;
        }

        .proof-button {
            background-color: #05867C;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 4px 12px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            margin-left: 10px;
            height: fit-content;
        }

        .proof-button i {
            font-size: 0.8rem;
        }
        
        #add-form-btn {
            border-radius: 6px !important;
        }

        .modal-content {
            border-radius: 12px !important;
        }

        .action-button {
            border-radius: 6px;
        }

        .modal .form-group input,
        .modal .form-group select {
            border-radius: 6px;
        }

        .action-buttons button {
            border-radius: 6px !important;
        }

        .form-buttons .action-button {
            border-radius: 6px;
        }

        /* Update modal input styles for smaller borders */
        .modal .input-icon input,
        .modal .input-icon select {
            border: 1px solid #e2e8f0;
        }

        /* For the export button */
        .button-group .action-button {
            border-radius: 6px !important;
        }
        
        /* Loading overlay styles */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        
        .loading-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(5, 134, 124, 0.2);
            border-radius: 50%;
            border-top-color: #05867C;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .overview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .overview-card {
            background: white;
            border-radius: 16px;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
        }

        .overview-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .overview-icon {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            background: rgba(5, 134, 124, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .overview-icon i {
            font-size: 24px;
            color: #05867C;
        }

        .overview-details h3 {
            color: #64748b;
            font-size: 0.9rem;
            margin-bottom: 5px;
        }

        .overview-details p {
            color: #334155;
            font-size: 1.5rem;
            font-weight: 600;
            margin: 0;
        }

        .charts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .chart-card {
            background: white;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .chart-card h3 {
            color: #05867C;
            font-size: 1.1rem;
            margin-bottom: 20px;
        }

        .chart-stats {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .stat-label {
            width: 80px;
            color: #64748b;
            font-size: 0.9rem;
        }

        .stat-bar {
            flex: 1;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
        }

        .stat-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 1s ease-in-out;
        }

        .stat-fill.normal {
            background-color: #05867C;
        }

        .stat-fill.grave {
            background-color: #dc3545;
        }

        .stat-value {
            width: 40px;
            text-align: right;
            color: #334155;
            font-weight: 500;
        }

        .activity-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-height: 300px;
            overflow-y: auto;
        }

        .activity-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px;
            border-radius: 8px;
            background: #f8fafc;
            transition: all 0.2s ease;
        }

        .activity-item:hover {
            transform: translateX(5px);
            background: #f1f5f9;
        }

        .activity-icon {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: rgba(5, 134, 124, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .activity-icon i {
            font-size: 16px;
            color: #05867C;
        }

        .activity-details {
            flex: 1;
        }

        .activity-details h4 {
            color: #334155;
            font-size: 0.9rem;
            margin: 0 0 2px 0;
        }

        .activity-details p {
            color: #64748b;
            font-size: 0.8rem;
            margin: 0;
        }

        .activity-time {
            color: #94a3b8;
            font-size: 0.8rem;
        }

        @media (max-width: 768px) {
            .overview-grid {
                grid-template-columns: 1fr;
            }
            
            .charts-container {
                grid-template-columns: 1fr;
            }
        }
        
        @media print {
            body {
                padding: 20px;
                font-size: 12pt;
            }
            
            button, .form-buttons {
                display: none !important;
            }
            
            #receipt-content {
                width: 100%;
                margin: 0;
                padding: 0;
            }
            
            .modal-content {
                box-shadow: none !important;
                border: none !important;
            }
        }
    </style>
    <style>
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loading-overlay">
        <div class="spinner"></div>
    </div>
    <div class="sidebar">
        <div class="logo">
            <img src="/logo.webp" class="logo-icon" alt="VetOnCall Logo">
        </div>
        <ul>
            <li>
                <a href="#" data-section="overview">
                    <i class="fas fa-chart-line"></i>
                    <span>Overview</span>
                </a>
            </li>
            <li id="veterinarians-menu-item" style="display: none;">
                <a href="#" data-section="veterinarians">
                    <i class="fas fa-user-md"></i>
                    <span>Veterinarians</span>
                </a>
            </li>
            <li>
                <a href="#" data-section="forms" class="active">
                    <i class="fas fa-file-alt"></i>
                    <span>Forms</span>
                </a>
            </li>
            <li>
                <a href="#" data-section="customers">
                    <i class="fas fa-users"></i>
                    <span>Customers</span>
                </a>
            </li>
            <li>
                <a href="#" data-section="payment">
                    <i class="fas fa-credit-card"></i>
                    <span>Payment</span>
                </a>
            </li>
            <li>
                <a href="#" data-section="schedule">
                    <i class="fas fa-calendar-alt"></i>
                    <span>Schedule</span>
                </a>
            </li>
            <li class="settings-item">
                <a href="#" data-section="settings">
                    <i class="fas fa-cog"></i>
                    <span>Settings</span>
                </a>
            </li>
            <li>
                <a href="#" id="logout-btn">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Logout</span>
                </a>
            </li>
        </ul>
    </div>
    <div class="content">
        
        <div id="overview-content" class="content-section">
            <h1>Overview</h1>
            
            <div class="overview-grid">
                <div class="overview-card">
                    <div class="overview-icon">
                        <i class="fas fa-user-md"></i>
                    </div>
                    <div class="overview-details">
                        <h3>Total Veterinarians</h3>
                        <p>15</p>
                    </div>
                </div>
                
                <div class="overview-card">
                    <div class="overview-icon">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="overview-details">
                        <h3>Active Customers</h3>
                        <p>248</p>
                    </div>
                </div>
                
                <div class="overview-card">
                    <div class="overview-icon">
                        <i class="fas fa-calendar-check"></i>
                    </div>
                    <div class="overview-details">
                        <h3>Appointments</h3>
                        <p>167</p>
                    </div>
                </div>
                
                <div class="overview-card">
                    <div class="overview-icon">
                        <i class="fas fa-money-bill-wave"></i>
                    </div>
                    <div class="overview-details">
                        <h3>Monthly Revenue</h3>
                        <p>286,500 DZD</p>
                    </div>
                </div>
            </div>

            <div class="charts-container">
                <div class="chart-card">
                    <h3>Appointment Types</h3>
                    <div class="chart-stats">
                        <div class="stat-item">
                            <div class="stat-label">Normal</div>
                            <div class="stat-bar">
                                <div class="stat-fill normal" style="width: 65%;"></div>
                            </div>
                            <div class="stat-value">65%</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">Grave</div>
                            <div class="stat-bar">
                                <div class="stat-fill grave" style="width: 35%;"></div>
                            </div>
                            <div class="stat-value">35%</div>
                        </div>
                    </div>
                </div>

                <div class="chart-card">
                    <h3>Monthly Revenue</h3>
                    <div class="revenue-chart">
                        <canvas id="revenueChart"></canvas>
                    </div>
                </div>

                <div class="chart-card">
                    <h3>Common Conditions (Last Month)</h3>
                    <div style="position: relative; height: 250px; margin-top: 15px;">
                        <canvas id="conditionsChart"></canvas>
                    </div>
                    <div class="chart-legend" style="margin-top: 15px; display: flex; flex-wrap: wrap; gap: 10px; justify-content: center;">
                        <div style="display: flex; align-items: center; gap: 5px;">
                            <span style="width: 12px; height: 12px; background-color: #05867C; border-radius: 50%;"></span>
                            <span style="font-size: 0.9rem; color: #64748b;">Vaccinations (35%)</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 5px;">
                            <span style="width: 12px; height: 12px; background-color: #dc3545; border-radius: 50%;"></span>
                            <span style="font-size: 0.9rem; color: #64748b;">Injuries (25%)</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 5px;">
                            <span style="width: 12px; height: 12px; background-color: #3b82f6; border-radius: 50%;"></span>
                            <span style="font-size: 0.9rem; color: #64748b;">Dental (20%)</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 5px;">
                            <span style="width: 12px; height: 12px; background-color: #f59e0b; border-radius: 50%;"></span>
                            <span style="font-size: 0.9rem; color: #64748b;">Infections (15%)</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 5px;">
                            <span style="width: 12px; height: 12px; background-color: #8b5cf6; border-radius: 50%;"></span>
                            <span style="font-size: 0.9rem; color: #64748b;">Others (5%)</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="veterinarians-content" class="content-section">
            <h1>Veterinarians</h1>
            <div class="action-buttons">
                <div class="search-container">
                    <input type="text" class="search-input" placeholder="Search veterinarians...">
                </div>
                <div class="button-group">
                    <button class="action-button" id="add-vet-btn">
                        <i class="fas fa-plus"></i> New Veterinarian
                    </button>
                    <button class="action-button" onclick="window.print()">
                        <i class="fas fa-file-export"></i> Export
                    </button>
                </div>
            </div>
            <table class="forms-table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Specialty</th>
                        <th>Phone Number</th>
                        <th>Email</th>
                        <th>Shift work</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="veterinarians-table-body">
                    <!-- Data will be populated dynamically -->
                </tbody>
            </table>
            <div class="pagination">
                <button><i class="fas fa-chevron-left"></i></button>
                <span>Page 1 of 1</span>
                <button><i class="fas fa-chevron-right"></i></button>
            </div>
        </div>
        <div id="forms-content" class="content-section">
            <h1>Forms</h1>
            <div class="action-buttons">
                <div class="search-container">
                    <input type="text" class="search-input" placeholder="Search forms...">
                    <div class="filter-buttons">
                        <div class="condition-filter normal" data-condition="Normal" title="Show Normal Condition"></div>
                        <div class="condition-filter grave" data-condition="Grave" title="Show Grave Condition"></div>
                    </div>
                </div>
                <div class="button-group">
                    <button class="action-button" id="add-form-btn">
                        <i class="fas fa-plus"></i> New Form
                    </button>
                    <button class="action-button" onclick="window.print()">
                        <i class="fas fa-file-export"></i> Export
                    </button>
                </div>
            </div>
            <table class="forms-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Time</th>
                        <th>Email</th>
                        <th>Owners</th>
                        <th>Pets</th>
                        <th>Phone Number</th>
                        <th>Assigned Veterinarian</th>
                        <th>Medical Condition</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="forms-table-body">
                    <!-- Data will be populated dynamically -->
                </tbody>
            </table>
            <div class="pagination">
                <button><i class="fas fa-chevron-left"></i></button>
                <span>Page 1 of 1</span>
                <button><i class="fas fa-chevron-right"></i></button>
            </div>
        </div>
        
        <div id="customers-content" class="content-section">
            <h1>Customers</h1>
            <div class="action-buttons">
                <div class="search-container">
                    <input type="text" class="search-input" placeholder="Search customers...">
                </div>
                <div class="button-group">
                    <button class="action-button" id="add-customer-btn">
                        <i class="fas fa-plus"></i> Add New Customer
                    </button>
                    <button class="action-button" onclick="window.print()">
                        <i class="fas fa-file-export"></i> Export
                    </button>
                </div>
            </div>
            <table class="forms-table">
                <thead>
                    <tr>
                        <th>Email</th>
                        <th>Owner</th>
                        <th>Pets</th>
                        <th>Phone Number</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="customers-table-body">
                    <!-- Data will be populated dynamically -->
                </tbody>
            </table>
            <div class="pagination">
                <button><i class="fas fa-chevron-left"></i></button>
                <span>Page 1 of 1</span>
                <button><i class="fas fa-chevron-right"></i></button>
            </div>
        </div>
        <div id="schedule-content" class="content-section">
            <h1>Schedule</h1>
            <div class="schedule-navigation">
                <button id="prev-month"><i class="fas fa-chevron-left"></i> Previous</button>
                <div class="schedule-controls">
                    <select id="dateRange" onchange="changeDateRange(this.value)">
                        <option value="day">Day</option>
                        <option value="week">Week</option>
                        <option value="month">Month</option>
                    </select>
                    <div class="current-month" id="current-month">March 2025</div>
                </div>
                <button id="next-month">Next <i class="fas fa-chevron-right"></i></button>
            </div>
            <div class="schedule-header">
                <div class="day-header">Sunday</div>
                <div class="day-header">Monday</div>
                <div class="day-header">Tuesday</div>
                <div class="day-header">Wednesday</div>
                <div class="day-header">Thursday</div>
                <div class="day-header">Friday</div>
                <div class="day-header">Saturday</div>
            </div>
            <div class="schedule-grid" id="schedule-grid">
                <!-- Days will be populated dynamically -->
            </div>
        </div>
        <div id="payment-content" class="content-section">
            <h1>Payment</h1>
            <div class="action-buttons">
                <div class="search-container">
                    <input type="text" class="search-input" placeholder="Search payments...">
                </div>
            </div>
            <table class="forms-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Time</th>
                        <th>Email</th>
                        <th>Owner</th>
                        <th>Pets</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="payment-table-body">
                    <!-- Data will be populated dynamically -->
                </tbody>
            </table>
            <div class="pagination">
                <button><i class="fas fa-chevron-left"></i></button>
                <span>Page 1 of 1</span>
                <button><i class="fas fa-chevron-right"></i></button>
            </div>
        </div>
        <div id="settings-content" class="content-section">
            <h1>Settings</h1>
            <div class="settings-container">
                <div class="settings-card profile-section">
                    <h2><i class="fas fa-user-circle"></i> Account Information</h2>
                    <div class="profile-info">
                        <div class="profile-field">
                            <label>Account Type</label>
                            <div class="info-value" id="account-type">Loading...</div>
                        </div>
                        <div class="profile-field">
                            <label>Name</label>
                            <div class="info-value" id="account-name">Loading...</div>
                        </div>
                        <div class="profile-field">
                            <label>Email</label>
                            <div class="info-value" id="account-email">Loading...</div>
                        </div>
                        <div class="profile-field">
                            <label>Phone</label>
                            <div class="info-value" id="account-phone">Loading...</div>
                        </div>
                        <div class="profile-field">
                            <label>Address</label>
                            <div class="info-value" id="account-address">Loading...</div>
                        </div>
                        <div class="profile-field" id="specialty-field" style="display: none;">
                            <label>Specialty</label>
                            <div class="info-value" id="account-specialty">Loading...</div>
                        </div>
                        <div class="profile-field">
                            <label>Working Days</label>
                            <div class="info-value" id="account-working-days">Loading...</div>
                        </div>
                        <div class="profile-field">
                            <label>Working Hours</label>
                            <div class="info-value" id="account-hours">Loading...</div>
                        </div>
                    </div>
                    <button class="edit-profile-btn">
                        <i class="fas fa-edit"></i> Edit Profile
                    </button>
                </div>

                <div class="settings-card">
                    <h2><i class="fas fa-lock"></i> Security</h2>
                    <div class="security-section">
                        <button class="change-password-btn">
                            <i class="fas fa-key"></i> Change Password
                        </button>
                        <button class="enable-2fa-btn">
                            <i class="fas fa-shield-alt"></i> Enable Two-Factor Authentication
                        </button>
                    </div>
                </div>

                <div class="settings-card">
                    <h2><i class="fas fa-bell"></i> Notifications</h2>
                    <div class="notifications-section">
                        <div class="notification-option">
                            <label class="switch">
                                <input type="checkbox" id="email-notifications">
                                <span class="slider round"></span>
                            </label>
                            <span>Email Notifications</span>
                        </div>
                        <div class="notification-option">
                            <label class="switch">
                                <input type="checkbox" id="sms-notifications">
                                <span class="slider round"></span>
                            </label>
                            <span>SMS Notifications</span>
                        </div>
                    </div>
                </div>

            </div>
        </div>

    </div>

    <script type="module">
        import { logOut, moveAppointmentToCustomers } from './firebase.js';
        import { getFirestore, collection, getDocs, deleteDoc, doc, addDoc, updateDoc, query, where, getDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDRA93HE5U6kFUc3pn88LLMePldezD8sAg",
            appId: "1:115836402892:web:82691841ac065d8b13d669",
            messagingSenderId: "115836402892",
            projectId: "vetoncall-33dee",
            authDomain: "vetoncall-33dee.firebaseapp.com",
            storageBucket: "vetoncall-33dee.firebasestorage.app"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        async function loadClinicVeterinarians(searchTerm = '') {
            showLoading();
            if (!auth.currentUser) {
                hideLoading();
                return;
            }

            try {
                // Get the clinic data first
                const clinicsRef = collection(db, "Clinics");
                const clinicSnapshot = await getDocs(query(clinicsRef, where("uid", "==", auth.currentUser.uid)));
                if (clinicSnapshot.empty) return;
                
                const clinicData = clinicSnapshot.docs[0].data();
                const clinicName = clinicData.name;
                const clinicEmail = clinicData.email;

                const workersRef = collection(db, "workers");
                const q = query(workersRef, where("clinicId", "==", auth.currentUser.uid));
                const querySnapshot = await getDocs(q);
                
                const tableBody = document.getElementById('veterinarians-table-body');
                if (!tableBody) return;
                
                tableBody.innerHTML = '';
                
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    
                    // If there's a search term, check if the vet name includes it (case insensitive)
                    if (searchTerm && !data.vetName.toLowerCase().includes(searchTerm.toLowerCase())) {
                        return; // Skip this item if it doesn't match the search
                    }
                    
                    const row = document.createElement('tr');
                    const statusClass = data.status === 'Night Shift' ? 'grave' : 'normal';
                    
                    row.innerHTML = `
                        <td>${data.vetName}</td>
                        <td>${data.specialty}</td>
                        <td>${data.vetPhone}</td>
                        <td>${data.vetEmail}</td>
                        <td><span class="status-badge ${statusClass}">${data.status}</span></td>
                        <td>
                            <i class="fas fa-edit action-icon edit-icon" title="Edit"></i>
                            <i class="fas fa-clock action-icon shift-icon" title="Change Shift" style="color: #3b82f6;"></i>
                            <i class="fas fa-trash-alt action-icon delete-icon" title="Delete"></i>
                        </td>
                    `;
                    
                    // Add event listeners
                    row.querySelector('.edit-icon').onclick = () => editClinicVet(doc.id, data);
                    row.querySelector('.shift-icon').onclick = () => changeShiftWork(doc.id, data);
                    row.querySelector('.delete-icon').onclick = () => deleteClinicVet(doc.id, row);
                    
                    tableBody.appendChild(row);
                });
                hideLoading();
            } catch (error) {
                console.error("Error loading veterinarians:", error);
                showNotification('Error loading veterinarians', 'error');
                hideLoading();
            }
        }

        async function showNewClinicVetForm() {
            showLoading();
            const modal = document.createElement('div');
            modal.className = 'modal';
            
            modal.innerHTML = `
                <div class="modal-content">
                    <h2 style="text-align: center; margin-bottom: 20px; color: #05867C;">Add Veterinarian</h2>
                    <span class="close">&times;</span>

                    <form id="newClinicVetForm" autocomplete="off">
                        <div class="form-group">
                            <label>Name</label>
                            <div class="input-icon">
                                <i class="fas fa-user"></i>
                                <input type="text" name="name" required autocomplete="off">
                            </div>
                            <div class="error-message"></div>
                        </div>
                        <div class="form-group">
                            <label>Phone Number</label>
                            <div class="input-icon">
                                <i class="fas fa-phone"></i>
                                <input type="tel" 
                                       name="phone" 
                                       required 
                                       autocomplete="off" 
                                       pattern="[0-9]{10}"
                                       maxlength="10"
                                       oninput="this.value = this.value.replace(/[^0-9]/g, '')"
                                       placeholder="Enter 10 digit phone number"
                                       title="Please enter exactly 10 digits">
                            </div>
                            <div class="error-message"></div>
                        </div>
                        <div class="form-group">
                            <label>Specialty</label>
                            <div class="input-icon">
                                <i class="fas fa-stethoscope"></i>
                                <select name="specialty" required>
                                    <option value="">Select specialty</option>
                                    <option value="Small Animals">Small Animals</option>
                                    <option value="Exotic Pets">Exotic Pets</option>
                                    <option value="Surgery">Surgery</option>
                                    <option value="Emergency Care">Emergency Care</option>
                                    <option value="General Practice">General Practice</option>
                                </select>
                            </div>
                            <div class="error-message"></div>
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <div class="input-icon">
                                <i class="fas fa-envelope"></i>
                                <input type="email" name="email" required autocomplete="off">
                            </div>
                            <div class="error-message"></div>
                        </div>
                        <div class="form-group">
                            <label>Shift work</label>
                            <div class="input-icon">
                                <i class="fas fa-clock"></i>
                                <select name="status" required>
                                    <option value="Day Shift">Day Shift</option>
                                    <option value="Night Shift">Night Shift</option>
                                </select>
                            </div>
                            <div class="error-message"></div>
                        </div>
                        <div class="form-buttons">
                            <button type="button" class="action-button close-btn" style="background-color: #94a3b8;">Cancel</button>
                            <button type="submit" class="action-button save-btn">Save</button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);

            // Close functionality 
            const closeBtn = modal.querySelector('.close');
            const closeBtnForms = modal.querySelectorAll('.close-btn');
            
            function closeModal() {
                modal.remove();
            }
            
            closeBtn.onclick = closeModal;
            closeBtnForms.forEach(btn => btn.onclick = closeModal);
            
            // Close when clicking outside
            window.onclick = function(event) {
                if (event.target == modal) {
                    closeModal();
                }
            }

            // Form validation for phone number
            const phoneInput = modal.querySelector('input[name="phone"]');
            phoneInput.addEventListener('input', (e) => {
                const value = e.target.value;
                e.target.value = value.replace(/[^0-9]/g, '');
                
                if (value.length !== 10) {
                    phoneInput.setCustomValidity('Phone number must be exactly 10 digits');
                    phoneInput.style.borderColor = '#dc3545';
                } else {
                    phoneInput.setCustomValidity('');
                    phoneInput.style.borderColor = '#e2e8f0';
                }
            });

            // Form submission
            const addVetForm = modal.querySelector('#newClinicVetForm');
            addVetForm.onsubmit = async function(e) {
                e.preventDefault();
                
                // Get clinic info first
                const clinicsRef = collection(db, "Clinics");
                const clinicSnapshot = await getDocs(query(clinicsRef, where("uid", "==", auth.currentUser.uid)));
                if (clinicSnapshot.empty) return;
                
                const clinicData = clinicSnapshot.docs[0].data();
                const clinicName = clinicData.name;
                const clinicEmail = clinicData.email;

                const formData = new FormData(addVetForm);
                
                const workerData = {
                    clinicId: auth.currentUser.uid,
                    clinicName: clinicName,
                    clinicEmail: clinicEmail,
                    vetName: formData.get('name'),
                    vetEmail: formData.get('email'),
                    vetPhone: formData.get('phone'),
                    specialty: formData.get('specialty'),
                    status: formData.get('status'),
                    createdAt: new Date()
                };

                try {
                    await addDoc(collection(db, "workers"), workerData);
                    showNotification('Veterinarian added successfully!');
                    closeModal();
                    loadClinicVeterinarians(); // Refresh the table
                    hideLoading();
                } catch (error) {
                    console.error("Error adding veterinarian:", error);
                    showNotification('Error adding veterinarian', 'error');
                    hideLoading();
                }
            };
            hideLoading();
        }

        async function editClinicVet(id, data) {
            showLoading();
            const modal = document.createElement('div');
            modal.className = 'modal';
            
            modal.innerHTML = `
                <div class="modal-content">
                    <h2 style="text-align: center; margin-bottom: 20px; color: #05867C;">Edit Veterinarian</h2>
                    <span class="close">&times;</span>

                    <form id="editClinicVetForm" autocomplete="off">
                        <div class="form-group">
                            <label>Name</label>
                            <div class="input-icon">
                                <i class="fas fa-user"></i>
                                <input type="text" name="name" required autocomplete="off" value="${data.vetName}">
                            </div>
                            <div class="error-message"></div>
                        </div>
                        <div class="form-group">
                            <label>Phone Number</label>
                            <div class="input-icon">
                                <i class="fas fa-phone"></i>
                                <input type="tel" 
                                       name="phone" 
                                       required 
                                       autocomplete="off" 
                                       pattern="[0-9]{10}"
                                       maxlength="10"
                                       value="${data.vetPhone}"
                                       oninput="this.value = this.value.replace(/[^0-9]/g, '')"
                                       placeholder="Enter 10 digit phone number"
                                       title="Please enter exactly 10 digits">
                            </div>
                            <div class="error-message"></div>
                        </div>
                        <div class="form-group">
                            <label>Specialty</label>
                            <div class="input-icon">
                                <i class="fas fa-stethoscope"></i>
                                <select name="specialty" required>
                                    <option value="">Select specialty</option>
                                    <option value="Small Animals" ${data.specialty === 'Small Animals' ? 'selected' : ''}>Small Animals</option>
                                    <option value="Exotic Pets" ${data.specialty === 'Exotic Pets' ? 'selected' : ''}>Exotic Pets</option>
                                    <option value="Surgery" ${data.specialty === 'Surgery' ? 'selected' : ''}>Surgery</option>
                                    <option value="Emergency Care" ${data.specialty === 'Emergency Care' ? 'selected' : ''}>Emergency Care</option>
                                    <option value="General Practice" ${data.specialty === 'General Practice' ? 'selected' : ''}>General Practice</option>
                                </select>
                            </div>
                            <div class="error-message"></div>
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <div class="input-icon">
                                <i class="fas fa-envelope"></i>
                                <input type="email" name="email" required autocomplete="off" value="${data.vetEmail}">
                            </div>
                            <div class="error-message"></div>
                        </div>
                        <div class="form-group">
                            <label>Shift work</label>
                            <div class="input-icon">
                                <i class="fas fa-clock"></i>
                                <select name="status" required>
                                    <option value="Day Shift" ${data.status === 'Day Shift' ? 'selected' : ''}>Day Shift</option>
                                    <option value="Night Shift" ${data.status === 'Night Shift' ? 'selected' : ''}>Night Shift</option>
                                </select>
                            </div>
                            <div class="error-message"></div>
                        </div>
                        <div class="form-buttons">
                            <button type="button" class="action-button close-btn" style="background-color: #94a3b8;">Cancel</button>
                            <button type="submit" class="action-button save-btn">Save Changes</button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);

            // Close functionality
            const closeBtn = modal.querySelector('.close');
            const cancelBtn = modal.querySelector('.close-btn');
            
            function closeModal() {
                modal.remove();
            }
            
            closeBtn.onclick = closeModal;
            cancelBtn.onclick = closeModal;
            
            // Close when clicking outside
            window.onclick = function(event) {
                if (event.target == modal) {
                    closeModal();
                }
            }

            // Phone number validation
            const phoneInput = modal.querySelector('input[name="phone"]');
            phoneInput.addEventListener('input', (e) => {
                const value = e.target.value;
                e.target.value = value.replace(/[^0-9]/g, '');
                
                if (value.length !== 10) {
                    phoneInput.setCustomValidity('Phone number must be exactly 10 digits');
                    phoneInput.style.borderColor = '#dc3545';
                } else {
                    phoneInput.setCustomValidity('');
                    phoneInput.style.borderColor = '#e2e8f0';
                }
            });

            // Form submission
            const editForm = modal.querySelector('#editClinicVetForm');
            editForm.onsubmit = async function(e) {
                e.preventDefault();
                
                const formData = new FormData(editForm);
                
                const updatedData = {
                    vetName: formData.get('name'),
                    vetEmail: formData.get('email'),
                    vetPhone: formData.get('phone'),
                    specialty: formData.get('specialty'),
                    status: formData.get('status'),
                    updatedAt: new Date()
                };

                try {
                    await updateDoc(doc(db, "workers", id), updatedData);
                    showNotification('Veterinarian updated successfully!');
                    closeModal();
                    loadClinicVeterinarians(); // Refresh the table
                    hideLoading();
                } catch (error) {
                    console.error("Error updating veterinarian:", error);
                    showNotification('Error updating veterinarian', 'error');
                    hideLoading();
                }
            };
            hideLoading();
        }

        async function deleteClinicVet(id, row) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 300px;">
                    <h2 style="text-align: center; margin-bottom: 20px; color: #05867C;">Confirm Delete</h2>
                    <p style="text-align: center; margin-bottom: 20px;">Are you sure you want to delete this veterinarian?</p>
                    <div class="form-buttons">
                        <button class="action-button close-btn" style="background-color: #94a3b8;">Cancel</button>
                        <button class="action-button save-btn" style="background-color: #dc3545;">Delete</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);

            return new Promise((resolve) => {
                const cancelBtn = modal.querySelector('.close-btn');
                const deleteBtn = modal.querySelector('.save-btn');
                
                function closeModal() {
                    modal.remove();
                    resolve(false);
                }
                
                cancelBtn.onclick = closeModal;
                
                deleteBtn.onclick = async () => {
                    const originalContent = deleteBtn.innerHTML;
                    deleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Deleting...';
                    deleteBtn.disabled = true;
                    
                    try {
                        await deleteDoc(doc(db, "workers", id));
                        showNotification('Veterinarian deleted successfully!');
                        row.remove();
                        closeModal();
                        resolve(true);
                    } catch (error) {
                        console.error("Error deleting veterinarian:", error);
                        showNotification('Error deleting veterinarian', 'error');
                        deleteBtn.innerHTML = originalContent;
                        deleteBtn.disabled = false;
                        closeModal();
                        resolve(false);
                    }
                };

                // Close when clicking outside
                window.onclick = function(event) {
                    if (event.target == modal) {
                        closeModal();
                    }
                }
            });
        }

        async function changeShiftWork(id, data) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 400px;">
                    <h2 style="text-align: center; margin-bottom: 20px; color: #05867C;">Change Shift Work</h2>
                    <span class="close">&times;</span>

                    <form id="shift-work-form">
                        <div class="form-group">
                            <label>Current Shift: <span class="status-badge ${data.status === 'Night Shift' ? 'grave' : 'normal'}">${data.status}</span></label>
                            <div class="input-icon" style="margin-top: 10px;">
                                <i class="fas fa-clock"></i>
                                <select name="status" required>
                                    <option value="Day Shift" ${data.status === 'Day Shift' ? 'selected' : ''}>Day Shift</option>
                                    <option value="Night Shift" ${data.status === 'Night Shift' ? 'selected' : ''}>Night Shift</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-buttons">
                            <button type="button" class="action-button close-btn" style="background-color: #94a3b8;">Cancel</button>
                            <button type="submit" class="action-button save-btn">Save Changes</button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);

            // Close functionality
            const closeBtn = modal.querySelector('.close');
            const cancelBtn = modal.querySelector('.close-btn');
            
            function closeModal() {
                modal.remove();
            }
            
            closeBtn.onclick = closeModal;
            cancelBtn.onclick = closeModal;
            
            // Form submission
            const form = modal.querySelector('#shift-work-form');
            form.onsubmit = async function(e) {
                e.preventDefault();
                showLoading();
                
                const formData = new FormData(form);
                const newStatus = formData.get('status');
                
                try {
                    await updateDoc(doc(db, "workers", id), {
                        status: newStatus,
                        updatedAt: new Date()
                    });
                    
                    showNotification('Shift work updated successfully!');
                    closeModal();
                    loadClinicVeterinarians();
                } catch (error) {
                    console.error("Error updating shift work:", error);
                    showNotification('Error updating shift work', 'error');
                } finally {
                    hideLoading();
                }
            };
            
            // Close when clicking outside
            window.onclick = function(event) {
                if (event.target == modal) {
                    closeModal();
                }
            }
        }

        async function loadForms(searchTerm = '', condition = '') {
            showLoading();
            if (!auth.currentUser) {
                hideLoading();
                return;
            }

            try {
                const appointmentsRef = collection(db, "appointments");
                const q = query(appointmentsRef, 
                       where("locationEmail", "==", auth.currentUser.email),
                       where("status", "==", "pending"));
                const querySnapshot = await getDocs(q);
                
                const tableBody = document.getElementById('forms-table-body');
                if (!tableBody) return;
                
                tableBody.innerHTML = '';
                
                if (querySnapshot.empty) {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="9" class="empty-state">
                                <i class="fas fa-calendar-times"></i>
                                <p>No pending appointments found</p>
                            </td>
                        </tr>
                    `;
                    hideLoading();
                    return;
                }

                // Check if user is a veterinarian or clinic
                const clinicsRef = collection(db, "Clinics");
                const clinicSnapshot = await getDocs(query(clinicsRef, where("uid", "==", auth.currentUser.uid)));
                const isClinic = !clinicSnapshot.empty;
                
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    
                    // Filter by search term and condition
                    if ((searchTerm && !Object.values(data).some(value => 
                        String(value).toLowerCase().includes(searchTerm.toLowerCase())
                    )) || (condition && data.medicalCondition !== condition)) {
                        return;
                    }
                    
                    const row = document.createElement('tr');
                    const statusClass = data.medicalCondition === 'Grave' ? 'grave' : 'normal';
                    
                    row.innerHTML = `
                        <td>${data.date}</td>
                        <td>${data.time}</td>
                        <td>${data.email}</td>
                        <td>${data.owners}</td>
                        <td>${data.pets}</td>
                        <td>${data.phoneNumber}</td>
                        ${isClinic ? `<td>${data.assignedVet || 'Not assigned'}</td>` : ''}
                        <td><span class="status-badge ${statusClass}">${data.medicalCondition}</span></td>
                        <td>
                            <i class="fas fa-edit action-icon edit-icon"></i>
                            <i class="fas fa-trash-alt action-icon delete-icon"></i>
                        </td>
                    `;
                    
                    // Add event handlers
                    row.querySelector('.edit-icon').onclick = () => editForm(doc.id, data);
                    row.querySelector('.delete-icon').onclick = () => deleteForm(doc.id, row);
                    
                    tableBody.appendChild(row);
                });
                hideLoading();
            } catch (error) {
                console.error("Error loading forms:", error);
                showNotification('Error loading forms', 'error');
                hideLoading();
            }
        }

        async function showNewFormModal(customerData = null) {
            showLoading();
            const modal = document.createElement('div');
            modal.className = 'modal';
            
            // Check if user is a veterinarian or clinic
            const clinicsRef = collection(db, "Clinics");
            const clinicSnapshot = await getDocs(query(clinicsRef, where("uid", "==", auth.currentUser.uid)));
            const isClinic = !clinicSnapshot.empty;
            
            // Pre-fill values for email, owners, pets, and phone if customerData exists
            const preFilledEmail = customerData ? customerData.email : '';
            const preFilledOwners = customerData ? customerData.owners : '';
            const preFilledPets = customerData ? customerData.pets : '';
            const preFilledPhone = customerData ? customerData.phoneNumber : '';
            
            // Create HTML content, conditionally include assigned vet field
            const assignedVetField = isClinic ? `
                <div class="form-group">
                    <label>Assigned Veterinarian</label>
                    <div class="input-icon">
                        <i class="fas fa-user-md"></i>
                        <select name="assignedVet" required>
                            <option value="">Select veterinarian</option>
                            <!-- Options will be populated dynamically -->
                        </select>
                    </div>
                </div>
            ` : '';
            
            modal.innerHTML = `
                <div class="modal-content">
                    <h2 style="text-align: center; margin-bottom: 20px; color: #05867C;">Add New Form</h2>
                    <span class="close">&times;</span>

                    <form id="newFormForm" autocomplete="off">
                        <div class="form-group">
                            <label>Date</label>
                            <div class="input-icon">
                                <i class="fas fa-calendar"></i>
                                <input type="date" name="date" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Time</label>
                            <div class="input-icon">
                                <i class="fas fa-clock"></i>
                                <input type="time" name="time" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <div class="input-icon">
                                <i class="fas fa-envelope"></i>
                                <input type="email" name="email" required value="${preFilledEmail}">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Owner Name</label>
                            <div class="input-icon">
                                <i class="fas fa-user"></i>
                                <input type="text" name="owners" required value="${preFilledOwners}">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Pets</label>
                            <div class="input-icon">
                                <i class="fas fa-paw"></i>
                                <input type="text" name="pets" required value="${preFilledPets}" placeholder="e.g., Dog, Cat">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Phone Number</label>
                            <div class="input-icon">
                                <i class="fas fa-phone"></i>
                                <input type="tel" 
                                       name="phoneNumber" 
                                       required 
                                       pattern="[0-9]{10}"
                                       maxlength="10"
                                       value="${preFilledPhone}"
                                       oninput="this.value = this.value.replace(/[^0-9]/g, '')"
                                       placeholder="Enter 10 digit phone number">
                            </div>
                            <div class="error-message"></div>
                        </div>
                        ${assignedVetField}
                        <div class="form-group">
                            <label>Medical Condition</label>
                            <div class="input-icon">
                                <i class="fas fa-heartbeat"></i>
                                <select name="medicalCondition" required>
                                    <option value="Normal">Normal</option>
                                    <option value="Grave">Grave</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-buttons">
                            <button type="button" class="action-button close-btn" style="background-color: #94a3b8;">Cancel</button>
                            <button type="submit" class="action-button save-btn">Save</button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);

            // Close functionality
            const closeBtn = modal.querySelector('.close');
            const cancelBtn = modal.querySelector('.close-btn');
            
            function closeModal() {
                modal.remove();
            }
            
            closeBtn.onclick = closeModal;
            cancelBtn.onclick = closeModal;
            
            // Close when clicking outside
            window.onclick = function(event) {
                if (event.target == modal) {
                    closeModal();
                }
            }

            // Phone validation
            const phoneInput = modal.querySelector('input[name="phoneNumber"]');
            phoneInput.addEventListener('input', (e) => {
                const value = e.target.value;
                e.target.value = value.replace(/[^0-9]/g, '');
                
                if (value.length !== 10) {
                    phoneInput.setCustomValidity('Phone number must be exactly 10 digits');
                    phoneInput.style.borderColor = '#dc3545';
                } else {
                    phoneInput.setCustomValidity('');
                    phoneInput.style.borderColor = '#e2e8f0';
                }
            });

            // Form submission
            const form = modal.querySelector('#newFormForm');
            form.onsubmit = async function(e) {
                e.preventDefault();
                
                const formData = new FormData(form);
                
                const data = {
                    locationEmail: auth.currentUser.email,
                    date: formData.get('date'),
                    time: formData.get('time'),
                    email: formData.get('email'),
                    owners: formData.get('owners'),
                    pets: formData.get('pets'),
                    phoneNumber: formData.get('phoneNumber'),
                    medicalCondition: formData.get('medicalCondition'),
                    status: "pending",
                    createdAt: new Date()
                };
                
                // Only add assignedVet field if user is a clinic
                if (isClinic) {
                    const assignedVetSelect = document.querySelector('select[name="assignedVet"]');
                    const selectedOption = assignedVetSelect.options[assignedVetSelect.selectedIndex];
                    data.assignedVet = formData.get('assignedVet');
                    data.vetEmail = selectedOption ? selectedOption.getAttribute('data-email') : '';
                } else {
                    // For veterinarian users, set their name as the assignedVet
                    const vetsRef = collection(db, "Veterinarians");
                    const vetSnapshot = await getDocs(query(vetsRef, where("uid", "==", auth.currentUser.uid)));
                    if (!vetSnapshot.empty) {
                        const vetData = vetSnapshot.docs[0].data();
                        data.assignedVet = vetData.name;
                        data.vetEmail = vetData.email;
                    }
                }

                try {
                    await addDoc(collection(db, "appointments"), data);
                    showNotification('Form added successfully!');
                    closeModal();
                    loadForms();
                    hideLoading();
                } catch (error) {
                    console.error("Error adding form:", error);
                    showNotification('Error adding form', 'error');
                    hideLoading();
                }
            };
            
            // Only populate vet select for clinics
            if (isClinic) {
                const vetSelect = modal.querySelector('select[name="assignedVet"]');
                if (vetSelect) {
                    await populateVetSelect(vetSelect);
                }
            }
            hideLoading();
        }

        async function editForm(id, data) {
            showLoading();
            const modal = document.createElement('div');
            modal.className = 'modal';
            
            // Check if user is a veterinarian or clinic
            const clinicsRef = collection(db, "Clinics");
            const clinicSnapshot = await getDocs(query(clinicsRef, where("uid", "==", auth.currentUser.uid)));
            const isClinic = !clinicSnapshot.empty;
            
            // Create HTML content, conditionally include assigned vet field
            const assignedVetField = isClinic ? `
                <div class="form-group">
                    <label>Assigned Veterinarian</label>
                    <div class="input-icon">
                        <i class="fas fa-user-md"></i>
                        <select name="assignedVet" required>
                            <option value="">Select veterinarian</option>
                            <!-- Will be populated dynamically -->
                        </select>
                    </div>
                </div>
            ` : '';
            
            modal.innerHTML = `
                <div class="modal-content">
                    <h2 style="text-align: center; margin-bottom: 20px; color: #05867C;">Edit Form</h2>
                    <span class="close">&times;</span>

                    <form id="editFormForm" autocomplete="off">
                        <div class="form-group">
                            <label>Date</label>
                            <div class="input-icon">
                                <i class="fas fa-calendar"></i>
                                <input type="date" name="date" required value="${data.date}">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Time</label>
                            <div class="input-icon">
                                <i class="fas fa-clock"></i>
                                <input type="time" name="time" required value="${data.time}">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <div class="input-icon">
                                <i class="fas fa-envelope"></i>
                                <input type="email" name="email" required value="${data.email}">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Owner Name</label>
                            <div class="input-icon">
                                <i class="fas fa-user"></i>
                                <input type="text" name="owners" required value="${data.owners}">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Pets</label>
                            <div class="input-icon">
                                <i class="fas fa-paw"></i>
                                <input type="text" name="pets" required value="${data.pets}">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Phone Number</label>
                            <div class="input-icon">
                                <i class="fas fa-phone"></i>
                                <input type="tel" 
                                       name="phoneNumber" 
                                       required 
                                       pattern="[0-9]{10}"
                                       maxlength="10"
                                       value="${data.phoneNumber}"
                                       oninput="this.value = this.value.replace(/[^0-9]/g, '')"
                                       placeholder="Enter 10 digit phone number">
                            </div>
                            <div class="error-message"></div>
                        </div>
                        ${assignedVetField}
                        <div class="form-group">
                            <label>Medical Condition</label>
                            <div class="input-icon">
                                <i class="fas fa-heartbeat"></i>
                                <select name="medicalCondition" required>
                                    <option value="Normal" ${data.medicalCondition === 'Normal' ? 'selected' : ''}>Normal</option>
                                    <option value="Grave" ${data.medicalCondition === 'Grave' ? 'selected' : ''}>Grave</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-buttons">
                            <button type="button" class="action-button close-btn" style="background-color: #94a3b8;">Cancel</button>
                            <button type="submit" class="action-button save-btn">Save Changes</button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);

            // Close functionality
            const closeBtn = modal.querySelector('.close');
            const cancelBtn = modal.querySelector('.close-btn');
            
            function closeModal() {
                modal.remove();
            }
            
            closeBtn.onclick = closeModal;
            cancelBtn.onclick = closeModal;

            // Phone validation
            const phoneInput = modal.querySelector('input[name="phoneNumber"]');
            phoneInput.addEventListener('input', (e) => {
                const value = e.target.value;
                e.target.value = value.replace(/[^0-9]/g, '');
                
                if (value.length !== 10) {
                    phoneInput.setCustomValidity('Phone number must be exactly 10 digits');
                    phoneInput.style.borderColor = '#dc3545';
                } else {
                    phoneInput.setCustomValidity('');
                    phoneInput.style.borderColor = '#e2e8f0';
                }
            });

            // Form submission
            const form = modal.querySelector('#editFormForm');
            form.onsubmit = async function(e) {
                e.preventDefault();
                
                const formData = new FormData(form);
                
                const updatedData = {
                    date: formData.get('date'),
                    time: formData.get('time'),
                    email: formData.get('email'),
                    owners: formData.get('owners'),
                    pets: formData.get('pets'),
                    phoneNumber: formData.get('phoneNumber'),
                    medicalCondition: formData.get('medicalCondition'),
                    updatedAt: new Date()
                };
                
                // Only update assignedVet if user is a clinic
                if (isClinic) {
                    const assignedVetSelect = document.querySelector('select[name="assignedVet"]');
                    const selectedOption = assignedVetSelect.options[assignedVetSelect.selectedIndex];
                    updatedData.assignedVet = formData.get('assignedVet');
                    updatedData.vetEmail = selectedOption ? selectedOption.getAttribute('data-email') : '';
                }

                try {
                    await updateDoc(doc(db, "appointments", id), updatedData);
                    showNotification('Form updated successfully!');
                    closeModal();
                    loadForms();
                    hideLoading();
                } catch (error) {
                    console.error("Error updating form:", error);
                    showNotification('Error updating form', 'error');
                    hideLoading();
                }
            };
            
            // Only populate vet select for clinics
            if (isClinic) {
                const vetSelect = modal.querySelector('select[name="assignedVet"]');
                if (vetSelect) {
                    await populateVetSelect(vetSelect);
                    if (data.assignedVet) {
                        vetSelect.value = data.assignedVet;
                    }
                }
            }
            hideLoading();
        }

        async function deleteForm(id, row) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 300px;">
                    <h2 style="text-align: center; margin-bottom: 20px; color: #05867C;">Confirm Delete</h2>
                    <p style="text-align: center; margin-bottom: 20px;">Are you sure you want to delete this form?</p>
                    <div class="form-buttons">
                        <button class="action-button close-btn" style="background-color: #94a3b8;">Cancel</button>
                        <button class="action-button save-btn" style="background-color: #dc3545;">Delete</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);

            return new Promise((resolve) => {
                const cancelBtn = modal.querySelector('.close-btn');
                const deleteBtn = modal.querySelector('.save-btn');
                
                function closeModal() {
                    modal.remove();
                    resolve(false);
                }
                
                cancelBtn.onclick = closeModal;
                
                deleteBtn.onclick = async () => {
                    const originalContent = deleteBtn.innerHTML;
                    deleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Deleting...';
                    deleteBtn.disabled = true;
                    
                    try {
                        await deleteDoc(doc(db, "appointments", id));
                        showNotification('Form deleted successfully!');
                        row.remove();
                        closeModal();
                        resolve(true);
                    } catch (error) {
                        console.error("Error deleting form:", error);
                        showNotification('Error deleting form', 'error');
                        deleteBtn.innerHTML = originalContent;
                        deleteBtn.disabled = false;
                        closeModal();
                        resolve(false);
                    }
                };

                // Close when clicking outside
                window.onclick = function(event) {
                    if (event.target == modal) {
                        closeModal();
                    }
                }
            });
        }

        async function getAccountForms(uid) {
            try {
                const user = auth.currentUser;
                if (!user) return [];
                
                const appointmentsRef = collection(db, "appointments");
                const q = query(appointmentsRef, where("locationEmail", "==", user.email));
                const querySnapshot = await getDocs(q);
                
                return querySnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
            } catch (error) {
                console.error("Error getting forms:", error);
                throw error;
            }
        }

        async function loadVeterinarians() {
            const veterinariansRef = collection(db, "Veterinarians");
            const querySnapshot = await getDocs(veterinariansRef);
            const tableBody = document.getElementById('veterinarians-table-body');
            tableBody.innerHTML = '';
            
            querySnapshot.forEach((doc) => {
                const data = doc.data();
                const row = document.createElement('tr');
                const statusClass = data.status === 'On Call' ? 'grave' : 'normal';
                
                row.innerHTML = `
                    <td>${data.name}</td>
                    <td>${data.specialty}</td>
                    <td>${data.phone}</td>
                    <td>${data.email}</td>
                    <td><span class="status-badge ${statusClass}">${data.status}</span></td>
                    <td>
                        <i class="fas fa-edit action-icon edit-icon"></i>
                        <i class="fas fa-trash-alt action-icon delete-icon"></i>
                    </td>
                `;
                
                // Add event listeners
                row.querySelector('.edit-icon').onclick = () => editVet(doc.id, data);
                row.querySelector('.delete-icon').onclick = () => deleteVet(doc.id, row);
                
                tableBody.appendChild(row);
            });
        }

        async function populateVetSelect(selectElement) {
            if (!auth.currentUser) return;
            
            try {
                const workersRef = collection(db, "workers");
                const q = query(workersRef, where("clinicId", "==", auth.currentUser.uid));
                const querySnapshot = await getDocs(q);
                
                selectElement.innerHTML = '<option value="">Select veterinarian</option>';
                
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    const option = document.createElement('option');
                    option.value = data.vetName;
                    option.textContent = data.vetName;
                    option.setAttribute('data-email', data.vetEmail);
                    selectElement.appendChild(option);
                });
            } catch (error) {
                console.error("Error loading veterinarians:", error);
            }
        }

        async function showDaySchedule(dateStr) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            
            const date = new Date(dateStr);
            const formattedDate = date.toLocaleDateString('en-US', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            
            // Create basic modal structure
            modal.innerHTML = `
                <div class="modal-content day-schedule-modal">
                    <h2 style="text-align: center; margin-bottom: 20px; color: #05867C;">${formattedDate}</h2>
                    <span class="close">&times;</span>
                    
                    <div class="day-schedule" id="day-schedule">
                        <!-- Hours will be added here -->
                    </div>
                    
                    <div class="form-buttons" style="margin-top: 20px;">
                        <button type="button" class="action-button close-btn" style="background-color: #94a3b8;">Close</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);

            // Add hour slots from 8 AM to 7 PM
            const daySchedule = document.getElementById('day-schedule');
            
            for (let hour = 8; hour <= 19; hour++) {
                const hourSlot = document.createElement('div');
                hourSlot.className = 'hour-slot';
                
                const ampm = hour >= 12 ? 'PM' : 'AM';
                const displayHour = hour > 12 ? hour - 12 : hour;
                
                hourSlot.innerHTML = `
                    <div class="time-label">${displayHour}:00 ${ampm}</div>
                    <div class="time-slot" data-time="${hour}:00">
                        <div class="slot-content" id="slot-${hour}"></div>
                    </div>
                `;
                
                daySchedule.appendChild(hourSlot);
            }
            
            // Get appointments for this day and populate hour slots
            try {
                const appointmentsRef = collection(db, "appointments");
                const q = query(appointmentsRef, 
                       where("locationEmail", "==", auth.currentUser.email),
                       where("date", "==", dateStr));
                
                const querySnapshot = await getDocs(q);
                
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    const appointmentTime = data.time;
                    
                    // Extract hour from time string (format: HH:MM)
                    const hourMatch = appointmentTime.match(/^(\d+):/);
                    if (hourMatch) {
                        const hour = parseInt(hourMatch[1]);
                        const slotElement = document.getElementById(`slot-${hour}`);
                        
                        if (slotElement) {
                            const statusClass = data.medicalCondition === 'Grave' ? 'grave' : 'normal';
                            const appointmentEl = document.createElement('div');
                            appointmentEl.className = 'appointment-card';
                            appointmentEl.style.borderLeft = `3px solid ${data.medicalCondition === 'Grave' ? '#dc3545' : '#05867C'}`;
                            appointmentEl.innerHTML = `
                                <div class="time">${data.time}</div>
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div class="name" style="font-weight: bold; color: #05867C;">${data.owners}</div>
                                    <button class="proof-button" onclick="event.stopPropagation();">
                                        <i class="fas fa-check"></i> Proof
                                    </button>
                                </div>
                                <div class="pet">${data.pets}</div>
                                <div class="details">
                                    <div class="details-left">
                                        <span style="color: #333; font-weight: 500;">${data.assignedVet || 'Not assigned'}</span>
                                        <span class="status-badge ${statusClass}" style="margin-left: 5px; font-size: 10px;">${data.medicalCondition}</span>
                                    </div>
                                </div>
                            `;

                            // Add click handler for the proof button
                            const proofButton = appointmentEl.querySelector('.proof-button');
                            proofButton.addEventListener('click', async (e) => {
                                e.stopPropagation();
                                const proofModal = document.createElement('div');
                                proofModal.className = 'modal';
                                proofModal.innerHTML = `
                                    <div class="modal-content" style="max-width: 400px; padding: 25px;">
                                        <h2 style="text-align: center; margin-bottom: 25px; color: #05867C;">
                                            <i class="fas fa-history" style="margin-right: 10px;"></i>
                                            Confirm Visit
                                        </h2>
                                        <p style="text-align: center; margin-bottom: 20px;">Are you sure you want to confirm this visit?</p>
                                        <div style="margin-bottom: 20px;">
                                            <div style="display: flex; margin-bottom: 15px;">
                                                <div style="width: 80px; color: #64748b;">
                                                    <i class="fas fa-user" style="margin-right: 8px;"></i>
                                                    Owner:
                                                </div>
                                                <div style="font-weight: 500;">${data.owners}</div>
                                            </div>
                                            <div style="display: flex; margin-bottom: 15px;">
                                                <div style="width: 80px; color: #64748b;">
                                                    <i class="fas fa-paw" style="margin-right: 8px;"></i>
                                                    Pet:
                                                </div>
                                                <div style="font-weight: 500;">${data.pets}</div>
                                            </div>
                                            <div style="display: flex; align-items: center;">
                                                <div style="width: 80px; color: #64748b;">
                                                    <i class="fas fa-clock" style="margin-right: 8px;"></i>
                                                    Time:
                                                </div>
                                                <div style="font-weight: 500;">${data.time}</div>
                                            </div>
                                        </div>
                                        <div class="form-buttons">
                                            <button class="action-button close-btn" style="background-color: #94a3b8;">Close</button>
                                            <button class="action-button save-btn" style="background-color: #05867C;">
                                                <i class="fas fa-check" style="margin-right: 5px;"></i> Confirm Visit
                                            </button>
                                        </div>
                                    </div>
                                `;
                                
                                document.body.appendChild(proofModal);

                                // Close button functionality
                                const closeBtn = proofModal.querySelector('.close-btn');
                                closeBtn.onclick = () => proofModal.remove();

                                // Confirm button functionality
                                const confirmBtn = proofModal.querySelector('.save-btn');
                                confirmBtn.onclick = async () => {
                                    try {
                                        // Show payment modal instead of immediately moving to customers
                                        proofModal.remove();
                                        markAsPaid(doc.id, data, 'appointment', true);
                                    } catch (error) {
                                        console.error("Error confirming appointment:", error);
                                        showNotification('Error confirming appointment', 'error');
                                    }
                                };
                            });

                            slotElement.appendChild(appointmentEl);
                        }
                    }
                });
            } catch (error) {
                console.error("Error loading day appointments:", error);
            }
            
            // Close modal functionality
            const closeBtn = modal.querySelector('.close');
            const closeBtnForm = modal.querySelector('.close-btn');
            
            function closeModal() {
                modal.remove();
            }
            
            closeBtn.onclick = closeModal;
            closeBtnForm.onclick = () => {
                closeModal();
            };
            
            // Close when clicking outside
            window.onclick = function(event) {
                if (event.target == modal) {
                    closeModal();
                }
            }
        }

        async function showPreviousVisits(customerId, customerData) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 500px;">
                    <h2 style="text-align: center; margin-bottom: 25px; color: #05867C;">
                        <i class="fas fa-history" style="margin-right: 10px;"></i>
                        Previous Visits for ${customerData.owners}
                    </h2>
                    <span class="close">&times;</span>
                    
                    <div id="previous-visits-list" style="max-height: 400px; overflow-y: auto; margin-bottom: 20px; padding: 0 5px;">
                        <!-- Previous visits will be loaded here -->
                        <div style="text-align: center; padding: 20px;">
                            <i class="fas fa-spinner fa-spin" style="font-size: 24px; color: #05867C;"></i>
                            <p>Loading previous visits...</p>
                        </div>
                    </div>
                    
                    <div class="form-buttons">
                        <button class="action-button close-btn" style="background-color: #94a3b8;">Close</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Close functionality
            const closeBtn = modal.querySelector('.close');
            const cancelBtn = modal.querySelector('.close-btn');
            
            function closeModal() {
                modal.remove();
            }
            
            closeBtn.onclick = closeModal;
            cancelBtn.onclick = closeModal;
            
            // Close when clicking outside
            window.onclick = function(event) {
                if (event.target == modal) {
                    closeModal();
                }
            }

            // Load previous visits
            try {
                // Get all visits for this customer based on email and owner name
                const visitsRef = collection(db, "Customers");
                const q = query(visitsRef, 
                       where("email", "==", customerData.email),
                       where("owners", "==", customerData.owners));
                
                const querySnapshot = await getDocs(q);
                
                const visitsDiv = document.getElementById('previous-visits-list');
                visitsDiv.innerHTML = '';
                
                if (querySnapshot.empty) {
                    visitsDiv.innerHTML = `
                        <div style="text-align: center; padding: 20px;">
                            <i class="fas fa-calendar-times" style="font-size: 24px; color: #cbd5e1;"></i>
                            <p>No previous visits found</p>
                        </div>
                    `;
                    return;
                }

                // Sort visits by date, newest first
                const visits = [];
                querySnapshot.forEach(doc => {
                    const data = doc.data();
                    visits.push({
                        id: doc.id,
                        ...data,
                        sortDate: data.movedAt ? data.movedAt.toDate() : new Date(0)
                    });
                });

                visits.sort((a, b) => b.sortDate - a.sortDate);
                
                visits.forEach((visit) => {
                    const paymentStatus = visit.status === 'paid' ? 
                        '<span class="status-badge normal">Paid</span>' : 
                        '<span class="status-badge grave">Pending</span>';
                    const statusClass = visit.medicalCondition === 'Grave' ? 'grave' : 'normal';
                    
                    const visitItem = document.createElement('div');
                    visitItem.style.cssText = `
                        border-left: 3px solid #05867C;
                        border-radius: 8px;
                        padding: 15px;
                        margin-bottom: 15px;
                        background-color: #f8f9fa;
                        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
                    `;
                    
                    const visitDate = visit.movedAt ? new Date(visit.movedAt.toDate()).toLocaleDateString() : 'Date not available';
                    
                    visitItem.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <div style="font-weight: 500; color: #05867C;">
                                <i class="fas fa-calendar-day" style="margin-right: 8px;"></i>
                                ${visitDate} ${visit.time || ''}
                            </div>
                            <span class="status-badge ${statusClass}">${visit.medicalCondition}</span>
                        </div>
                        <div style="display: flex; margin-bottom: 8px; align-items: center;">
                            <div style="width: 80px; color: #64748b;">
                                <i class="fas fa-paw" style="margin-right: 8px;"></i>
                                Pet:
                            </div>
                            <div style="font-weight: 500;">${visit.pets}</div>
                        </div>
                        <div style="display: flex; align-items: center;">
                            <div style="width: 80px; color: #64748b;">
                                <i class="fas fa-user-md" style="margin-right: 8px;"></i>
                                Vet:
                            </div>
                            <div style="font-weight: 500;">${visit.assignedVet || 'Not assigned'}</div>
                        </div>
                        ${visit.status === 'paid' ? `
                            <div style="background-color: white; padding: 10px; border-radius: 6px; margin-top: 10px;">
                                <div style="display: flex; align-items: center; margin-bottom: 5px;">
                                    <div style="width: 100px; color: #64748b;">
                                        <i class="fas fa-briefcase-medical" style="margin-right: 8px;"></i>
                                        Service:
                                    </div>
                                    <div style="font-weight: 500;">${visit.serviceType || 'N/A'}</div>
                                </div>
                                <div style="display: flex; align-items: center; margin-bottom: 5px;">
                                    <div style="width: 100px; color: #64748b;">
                                        <i class="fas fa-money-bill" style="margin-right: 8px;"></i>
                                        Amount:
                                    </div>
                                    <div style="font-weight: 500;">${visit.amount ? visit.amount.toLocaleString() + ' DZD' : 'N/A'}</div>
                                </div>
                                <div style="display: flex; align-items: center;">
                                    <div style="width: 100px; color: #64748b;">
                                        <i class="fas fa-money-check" style="margin-right: 8px;"></i>
                                        Method:
                                    </div>
                                    <div style="font-weight: 500;">${visit.paymentMethod || 'N/A'}</div>
                                </div>
                            </div>
                        ` : ''}
                    `;

                    visitItem.addEventListener('mouseover', () => {
                        visitItem.style.transform = 'translateY(-2px)';
                        visitItem.style.boxShadow = '0 4px 8px rgba(0,0,0,0.1)';
                    });
                    
                    visitItem.addEventListener('mouseout', () => {
                        visitItem.style.transform = 'none';
                        visitItem.style.boxShadow = '0 2px 4px rgba(0,0,0,0.05)';
                    });
                    
                    visitsDiv.appendChild(visitItem);
                });
            } catch (error) {
                console.error("Error loading previous appointments:", error);
                document.getElementById('previous-visits-list').innerHTML = `
                    <div style="text-align: center; padding: 20px;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 24px; color: #dc3545;"></i>
                        <p>Error loading visits: ${error.message}</p>
                    </div>
                `;
            }
        }

        async function createNewFormFromCustomer(customerData) {
            showNewFormModal(customerData); // Pass the customer data to pre-fill the form
            hideLoading();
        }

        async function loadCustomers(searchTerm = '') {
            showLoading();
            if (!auth.currentUser) {
                hideLoading();
                return;
            }

            try {
                const customersRef = collection(db, "Customers");
                const q = query(customersRef, where("locationEmail", "==", auth.currentUser.email));
                const querySnapshot = await getDocs(q);
                
                const tableBody = document.getElementById('customers-table-body');
                if (!tableBody) return;
                
                tableBody.innerHTML = '';
                
                if (querySnapshot.empty) {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="4" class="empty-state">
                                <i class="fas fa-users"></i>
                                <p>No customers found</p>
                            </td>
                        </tr>
                    `;
                    hideLoading();
                    return;
                }

                // Create a map to store unique customers by email
                const uniqueCustomers = new Map();
                
                // Process all documents to get the latest data for each customer
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    const customerKey = `${data.email}-${data.owners}`; // Unique key combining email and owner name
                    
                    if (!uniqueCustomers.has(customerKey) || 
                        (data.movedAt && 
                         (!uniqueCustomers.get(customerKey).movedAt || 
                          data.movedAt.toDate() > uniqueCustomers.get(customerKey).movedAt.toDate()))) {
                        uniqueCustomers.set(customerKey, {
                            id: doc.id,
                            ...data
                        });
                    }
                });

                // Filter by search term if provided
                let filteredCustomers = Array.from(uniqueCustomers.values());
                if (searchTerm) {
                    filteredCustomers = filteredCustomers.filter(customer => 
                        Object.values(customer).some(value => 
                            String(value).toLowerCase().includes(searchTerm.toLowerCase())
                        )
                    );
                }

                // Display unique customers
                filteredCustomers.forEach((data) => {
                    const row = document.createElement('tr');
                    
                    row.innerHTML = `
                        <td>${data.email}</td>
                        <td>${data.owners}</td>
                        <td>${data.pets}</td>
                        <td>${data.phoneNumber || 'N/A'}</td>
                        <td>
                            <i class="fas fa-edit action-icon edit-icon"></i>
                            <i class="fas fa-history action-icon visits-icon" title="Previous Visits"></i>
                            <i class="fas fa-file-medical action-icon create-form-icon" title="Create New Form"></i>
                        </td>
                    `;
                    
                    // Add event listeners
                    row.querySelector('.edit-icon').onclick = () => editCustomer(data.id, data);
                    row.querySelector('.visits-icon').onclick = () => showPreviousVisits(data.id, data);
                    row.querySelector('.create-form-icon').onclick = () => createNewFormFromCustomer(data);
                    
                    tableBody.appendChild(row);
                });
                hideLoading();
            } catch (error) {
                console.error("Error loading customers:", error);
                showNotification('Error loading customers', 'error');
                hideLoading();
            }
        }

        async function editCustomer(id, data) {
            showLoading();
            const modal = document.createElement('div');
            modal.className = 'modal';
            
            modal.innerHTML = `
                <div class="modal-content">
                    <h2 style="text-align: center; margin-bottom: 20px; color: #05867C;">Edit Customer</h2>
                    <span class="close">&times;</span>

                    <form id="editCustomerForm" autocomplete="off">
                        <div class="form-group">
                            <label>Email</label>
                            <div class="input-icon">
                                <i class="fas fa-envelope"></i>
                                <input type="email" name="email" required value="${data.email}">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Owner Name</label>
                            <div class="input-icon">
                                <i class="fas fa-user"></i>
                                <input type="text" name="owners" required value="${data.owners}">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Pets</label>
                            <div class="input-icon">
                                <i class="fas fa-paw"></i>
                                <input type="text" name="pets" required value="${data.pets}">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Phone Number</label>
                            <div class="input-icon">
                                <i class="fas fa-phone"></i>
                                <input type="tel" 
                                       name="phoneNumber" 
                                       required 
                                       pattern="[0-9]{10}"
                                       maxlength="10"
                                       value="${data.phoneNumber}"
                                       oninput="this.value = this.value.replace(/[^0-9]/g, '')"
                                       placeholder="Enter 10 digit phone number">
                            </div>
                            <div class="error-message"></div>
                        </div>
                        <div class="form-buttons">
                            <button type="button" class="action-button close-btn" style="background-color: #94a3b8;">Cancel</button>
                            <button type="submit" class="action-button save-btn">Save Changes</button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);

            // Close functionality
            const closeBtn = modal.querySelector('.close');
            const cancelBtn = modal.querySelector('.close-btn');
            
            function closeModal() {
                modal.remove();
            }
            
            closeBtn.onclick = closeModal;
            cancelBtn.onclick = closeModal;

            // Phone validation
            const phoneInput = modal.querySelector('input[name="phoneNumber"]');
            phoneInput.addEventListener('input', (e) => {
                const value = e.target.value;
                e.target.value = value.replace(/[^0-9]/g, '');
                
                if (value.length !== 10) {
                    phoneInput.setCustomValidity('Phone number must be exactly 10 digits');
                    phoneInput.style.borderColor = '#dc3545';
                } else {
                    phoneInput.setCustomValidity('');
                    phoneInput.style.borderColor = '#e2e8f0';
                }
            });

            // Form submission
            const form = modal.querySelector('#editCustomerForm');
            form.onsubmit = async function(e) {
                e.preventDefault();
                
                const formData = new FormData(form);
                
                const updatedData = {
                    email: formData.get('email'),
                    owners: formData.get('owners'),
                    pets: formData.get('pets'),
                    phoneNumber: formData.get('phoneNumber'),
                    updatedAt: new Date()
                };

                try {
                    await updateDoc(doc(db, "Customers", id), updatedData);
                    showNotification('Customer updated successfully!');
                    closeModal();
                    loadCustomers();
                    hideLoading();
                } catch (error) {
                    console.error("Error updating customer:", error);
                    showNotification('Error updating customer', 'error');
                    hideLoading();
                }
            };
            hideLoading();
        }

        async function deleteCustomer(id, row) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 300px;">
                    <h2 style="text-align: center; margin-bottom: 20px; color: #05867C;">Confirm Delete</h2>
                    <p style="text-align: center; margin-bottom: 20px;">Are you sure you want to delete this customer?</p>
                    <div class="form-buttons">
                        <button class="action-button close-btn" style="background-color: #94a3b8;">Cancel</button>
                        <button class="action-button save-btn" style="background-color: #dc3545;">Delete</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);

            return new Promise((resolve) => {
                const cancelBtn = modal.querySelector('.close-btn');
                const deleteBtn = modal.querySelector('.save-btn');
                
                function closeModal() {
                    modal.remove();
                    resolve(false);
                }
                
                cancelBtn.onclick = closeModal;
                
                deleteBtn.onclick = async () => {
                    const originalContent = deleteBtn.innerHTML;
                    deleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Deleting...';
                    deleteBtn.disabled = true;
                    
                    try {
                        await deleteDoc(doc(db, "Customers", id));
                        showNotification('Customer deleted successfully!');
                        row.remove();
                        closeModal();
                        resolve(true);
                    } catch (error) {
                        console.error("Error deleting customer:", error);
                        showNotification('Error deleting customer', 'error');
                        deleteBtn.innerHTML = originalContent;
                        deleteBtn.disabled = false;
                        closeModal();
                        resolve(false);
                    }
                };

                // Close when clicking outside
                window.onclick = function(event) {
                    if (event.target == modal) {
                        closeModal();
                    }
                }
            });
        }

        async function showFormSelectionModal() {
            showLoading();
            const modal = document.createElement('div');
            modal.className = 'modal';
            
            modal.innerHTML = `
                <div class="modal-content">
                    <h2 style="text-align: center; margin-bottom: 20px; color: #05867C;">Select Form to Add Customer</h2>
                    <span class="close">&times;</span>

                    <div id="form-selection-list" style="max-height: 400px; overflow-y: auto;">
                        <!-- Forms will be loaded here -->
                        <div style="text-align: center; padding: 20px;">
                            <i class="fas fa-spinner fa-spin" style="font-size: 24px; color: #05867C;"></i>
                            <p>Loading forms...</p>
                        </div>
                    </div>
                    
                    <div class="form-buttons">
                        <button class="action-button close-btn" style="background-color: #94a3b8;">Cancel</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);

            // Close functionality
            const closeBtn = modal.querySelector('.close');
            const cancelBtn = modal.querySelector('.close-btn');
            
            function closeModal() {
                modal.remove();
            }
            
            closeBtn.onclick = closeModal;
            cancelBtn.onclick = closeModal;
            
            // Close when clicking outside
            window.onclick = function(event) {
                if (event.target == modal) {
                    closeModal();
                }
            }

            // Load form
            try {
                const appointmentsRef = collection(db, "appointments");
                const q = query(appointmentsRef, where("locationEmail", "==", auth.currentUser.email));
                const querySnapshot = await getDocs(q);
                
                const formList = document.getElementById('form-selection-list');
                formList.innerHTML = '';
                
                if (querySnapshot.empty) {
                    formList.innerHTML = `
                        <div style="text-align: center; padding: 20px;">
                            <i class="fas fa-file-alt" style="font-size: 24px; color: #cbd5e1;"></i>
                            <p>No forms available</p>
                        </div>
                    `;
                    hideLoading();
                    return;
                }

                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    const formItem = document.createElement('div');
                    formItem.style.cssText = `
                        border: 1px solid #e2e8f0;
                        border-radius: 8px;
                        padding: 15px;
                        margin-bottom: 10px;
                        background-color: #f8f9fa;
                        cursor: pointer;
                        transition: all 0.2s ease;
                    `;
                    
                    const statusClass = data.medicalCondition === 'Grave' ? 'grave' : 'normal';
                    
                    formItem.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <div style="font-weight: 500; color: #05867C;">
                                <i class="fas fa-calendar-day" style="margin-right: 8px;"></i>
                                <span>${data.date}</span>
                            </div>
                            <span class="status-badge ${statusClass}">${data.medicalCondition}</span>
                        </div>
                        <div style="margin-bottom: 5px;">
                            <strong>${data.owners}</strong> (${data.email})
                        </div>
                        <div style="color: #64748b;">
                            Pets: ${data.pets}
                        </div>
                    `;
                    
                    formItem.addEventListener('mouseover', () => {
                        formItem.style.transform = 'translateY(-2px)';
                        formItem.style.boxShadow = '0 4px 8px rgba(0,0,0,0.1)';
                    });
                    
                    formItem.addEventListener('mouseout', () => {
                        formItem.style.transform = 'none';
                        formItem.style.boxShadow = '0 2px 4px rgba(0,0,0,0.05)';
                    });
                    
                    formItem.addEventListener('click', async () => {
                        try {
                            await moveAppointmentToCustomers(doc.id, data);
                            showNotification('Customer added successfully!');
                            closeModal();
                            loadCustomers(); // Refresh customers list
                            loadForms(); // Refresh forms list
                            hideLoading();
                        } catch (error) {
                            console.error("Error adding customer:", error);
                            showNotification('Error adding customer', 'error');
                            hideLoading();
                        }
                    });
                    
                    formList.appendChild(formItem);
                });
                hideLoading();
            } catch (error) {
                console.error("Error loading forms:", error);
                document.getElementById('form-selection-list').innerHTML = `
                    <div style="text-align: center; padding: 20px;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 24px; color: #dc3545;"></i>
                        <p>Error loading forms: ${error.message}</p>
                    </div>
                `;
                hideLoading();
            }
        }

        async function loadPayments(searchTerm = '') {
            showLoading();
            if (!auth.currentUser) {
                hideLoading();
                return;
            }

            try {
                // Get both appointments and customers 
                const customersRef = collection(db, "Customers");
                const appointmentsRef = collection(db, "appointments");

                const [customersSnapshot, appointmentsSnapshot] = await Promise.all([
                    getDocs(query(customersRef, where("locationEmail", "==", auth.currentUser.email))),
                    getDocs(query(appointmentsRef, where("locationEmail", "==", auth.currentUser.email)))
                ]);
                
                const tableBody = document.getElementById('payment-table-body');
                if (!tableBody) return;
                
                tableBody.innerHTML = '';
                
                if (customersSnapshot.empty && appointmentsSnapshot.empty) {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="7" class="empty-state">
                                <i class="fas fa-money-bill-wave"></i>
                                <p>No payments found</p>
                            </td>
                        </tr>
                    `;
                    hideLoading();
                    return;
                }

                // Create a map to store unique customers by email + owner name
                const uniqueRecords = new Map();

                // Process customers collection
                customersSnapshot.forEach((doc) => {
                    const data = doc.data();
                    const recordKey = `${data.email}-${data.owners}`; // Unique key combining email and owner name
                    
                    if (!uniqueRecords.has(recordKey) || 
                        (data.paidAt && 
                         (!uniqueRecords.get(recordKey).paidAt || 
                          data.paidAt.toDate() > uniqueRecords.get(recordKey).paidAt.toDate()))) {
                        uniqueRecords.set(recordKey, {
                            id: doc.id,
                            ...data
                        });
                    }
                });

                // Process appointments collection
                appointmentsSnapshot.forEach((doc) => {
                    const data = doc.data();
                    const recordKey = `${data.email}-${data.owners}`;
                    
                    if (!uniqueRecords.has(recordKey) || 
                        (data.paidAt && 
                         (!uniqueRecords.get(recordKey).paidAt || 
                          data.paidAt.toDate() > uniqueRecords.get(recordKey).paidAt.toDate()))) {
                        uniqueRecords.set(recordKey, {
                            id: doc.id,
                            ...data
                        });
                    }
                });

                // Convert map to array and sort by date
                let allRecords = Array.from(uniqueRecords.values());
                
                // Filter by search term if provided
                if (searchTerm) {
                    allRecords = allRecords.filter(record => 
                        Object.values(record).some(value => 
                            String(value).toLowerCase().includes(searchTerm.toLowerCase())
                        )
                    );
                }

                // Sort by date, newest first
                allRecords.sort((a, b) => {
                    const dateA = a.paidAt ? a.paidAt.toDate() : new Date(0);
                    const dateB = b.paidAt ? b.paidAt.toDate() : new Date(0);
                    return dateB - dateA;
                });

                allRecords.forEach((data) => {
                    const row = document.createElement('tr');
                    let paymentStatus = data.status === 'paid' ? 
                        '<span class="status-badge normal">Paid</span>' : 
                        '<span class="status-badge grave">Pending</span>';

                    if (data.type === 'customer' && !data.status) {
                        paymentStatus = '<span class="status-badge grave">Pending</span>';
                    }
                    
                    row.innerHTML = `
                        <td>${data.date}</td>
                        <td>${data.time}</td>
                        <td>${data.email}</td>
                        <td>${data.owners}</td>
                        <td>${data.pets}</td>
                        <td>${paymentStatus}</td>
                        <td>
                            ${data.status !== 'paid' ? 
                                `<button class="action-button pay-button" style="font-size: 0.8rem; padding: 5px 10px;">
                                    <i class="fas fa-credit-card"></i> Mark as Paid
                                </button>` : 
                                `<div style="display: flex; align-items: center; gap: 10px;">
                                    <i class="fas fa-check-circle" style="color: #10b981; font-size: 1.2rem;"></i>
                                    <i class="fas fa-history action-icon visit-history" style="color: #3b82f6; cursor: pointer;" 
                                       title="Payment History"></i>
                                    <i class="fas fa-file-medical action-icon print-receipt" style="color: #05867C; cursor: pointer;"
                                       title="Print Receipt"></i>
                                </div>`
                            }
                        </td>
                    `;
                    
                    // Add event listeners
                    const payButton = row.querySelector('.pay-button');
                    if (payButton) {
                        payButton.addEventListener('click', () => markAsPaid(data.id, data, data.type));
                    }

                    const historyIcon = row.querySelector('.visit-history');
                    if (historyIcon) {
                        historyIcon.addEventListener('click', () => showPaymentHistory(data.email, data.owners));
                    }
                    
                    const receiptIcon = row.querySelector('.print-receipt');
                    if (receiptIcon) {
                        receiptIcon.addEventListener('click', () => showReceiptModal(data));
                    }
                    
                    tableBody.appendChild(row);
                });
                hideLoading();
            } catch (error) {
                console.error("Error loading payments:", error);
                showNotification('Error loading payments', 'error');
                hideLoading();
            }
        }

        async function markAsPaid(id, data, type, isConfirmVisit = false) {
            try {
                const modal = document.createElement('div');
                modal.className = 'modal';
                
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 400px;">
                        <h2 style="text-align: center; margin-bottom: 20px; color: #05867C;">Payment Confirmation</h2>
                        <span class="close">&times;</span>
                        
                        <div style="margin-bottom: 20px;">
                            <div style="display: flex; margin-bottom: 10px;">
                                <div style="width: 100px; color: #64748b;">
                                    <i class="fas fa-user" style="margin-right: 8px;"></i>
                                    Owner:
                                </div>
                                <div style="font-weight: 500;">${data.owners}</div>
                            </div>
                            <div style="display: flex; margin-bottom: 10px;">
                                <div style="width: 100px; color: #64748b;">
                                    <i class="fas fa-paw" style="margin-right: 8px;"></i>
                                    Pet:
                                </div>
                                <div style="font-weight: 500;">${data.pets}</div>
                            </div>
                            <div style="display: flex; margin-bottom: 20px;">
                                <div style="width: 100px; color: #64748b;">
                                    <i class="fas fa-clock" style="margin-right: 8px;"></i>
                                    Time:
                                </div>
                                <div style="font-weight: 500;">${data.time}</div>
                            </div>
                            <div class="form-group">
                                <label>Service Type</label>
                                <div class="input-icon">
                                    <i class="fas fa-briefcase-medical"></i>
                                    <select id="service-type" required>
                                        <option value="">Select service</option>
                                        <option value="consultation">Consultation</option>
                                        <option value="vaccination">Vaccination</option>
                                        <option value="surgery">Surgery</option>
                                        <option value="grooming">Grooming</option>
                                        <option value="emergency">Emergency Care</option>
                                        <option value="dental">Dental Care</option>
                                    </select>
                                </div>
                            </div>

                            <div class="form-group">
                                <label>Amount (DZD)</label>
                                <div class="input-icon">
                                    <i class="fas fa-money-bill"></i>
                                    <input type="number" 
                                           id="payment-amount" 
                                           required 
                                           min="0" 
                                           step="1" 
                                           placeholder="Enter amount in DZD"
                                           style="padding-left: 45px;">
                                </div>
                            </div>

                            <div class="form-group">
                                <label>Payment Method</label>
                                <div class="input-icon">
                                    <i class="fas fa-money-check"></i>
                                    <select id="payment-method" required>
                                        <option value="cash">Cash</option>
                                        <option value="credit-card">Credit Card</option>
                                        <option value="bank-transfer">Bank Transfer</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-buttons">
                            <button class="action-button close-btn" style="background-color: #94a3b8;">Cancel</button>
                            <button class="action-button save-btn" style="background-color: #10b981;">
                                <i class="fas fa-check-circle" style="margin-right: 5px;"></i> Confirm Payment
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // Close functionality
                const closeBtn = modal.querySelector('.close');
                const cancelBtn = modal.querySelector('.close-btn');
                const confirmBtn = modal.querySelector('.save-btn');
                
                function closeModal() {
                    modal.remove();
                }
                
                closeBtn.onclick = closeModal;
                cancelBtn.onclick = closeModal;
                
                // Confirm payment
                confirmBtn.onclick = async () => {
                    const confirmBtn = modal.querySelector('.save-btn');
                    const originalContent = confirmBtn.innerHTML;
                    confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
                    confirmBtn.disabled = true;
                    showLoading();
                    
                    try {
                        const serviceType = document.getElementById('service-type').value;
                        const amount = document.getElementById('payment-amount').value;
                        const paymentMethod = document.getElementById('payment-method').value;

                        if (!serviceType || !amount || !paymentMethod) {
                            showNotification('Please fill in all payment details', 'error');
                            confirmBtn.innerHTML = originalContent;
                            confirmBtn.disabled = false;
                            hideLoading();
                            return;
                        }

                        // Add artificial delay of 1 second
                        await new Promise(resolve => setTimeout(resolve, 1000));

                        // Handle different flows based on if this is a confirmation visit
                        if (isConfirmVisit) {
                            // Create a new entry in Customers collection with payment info
                            await addDoc(collection(db, "Customers"), {
                                ...data,
                                status: "paid",
                                serviceType: serviceType,
                                amount: Number(amount),
                                paymentMethod: paymentMethod,
                                paidAt: new Date(),
                                movedAt: new Date()
                            });
                            
                            // Delete from appointments collection
                            await deleteDoc(doc(db, "appointments", id));
                            
                            showNotification('Appointment confirmed and payment processed!');
                        } else {
                            // Check if customer already exists
                            const customersRef = collection(db, "Customers");
                            const q = query(customersRef, 
                                where("email", "==", data.email),
                                where("owners", "==", data.owners));
                            const querySnapshot = await getDocs(q);

                            if (querySnapshot.empty) {
                                // Customer doesn't exist, create new entry
                                await addDoc(collection(db, "Customers"), {
                                    ...data,
                                    status: "paid",
                                    serviceType: serviceType,
                                    amount: Number(amount),
                                    paymentMethod: paymentMethod,
                                    paidAt: new Date(),
                                    movedAt: new Date()
                                });
                            } else {
                                // Customer exists, update their information
                                const customerDoc = querySnapshot.docs[0];
                                await updateDoc(doc(db, "Customers", customerDoc.id), {
                                    status: "paid",
                                    serviceType: serviceType,
                                    amount: Number(amount),
                                    paymentMethod: paymentMethod,
                                    paidAt: new Date(),
                                    movedAt: new Date()
                                });
                            }

                            // If this was from appointments collection, delete it
                            if (type === 'appointment') {
                                await deleteDoc(doc(db, "appointments", id));
                            }
                            
                            showNotification('Payment processed successfully!');
                        }
                        
                        closeModal();
                        loadPayments();
                        loadForms();
                    } catch (error) {
                        console.error("Error processing payment:", error);
                        showNotification('Error processing payment', 'error');
                    } finally {
                        confirmBtn.innerHTML = originalContent;
                        confirmBtn.disabled = false;
                        hideLoading();
                    }
                };
                
                // Close when clicking outside
                window.onclick = function(event) {
                    if (event.target == modal) {
                        closeModal();
                    }
                }
            } catch (error) {
                console.error("Error in markAsPaid:", error);
                showNotification('Error processing payment', 'error');
                hideLoading();
            }
        }

        async function showPaymentHistory(email, ownerName) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 500px;">
                    <h2 style="text-align: center; margin-bottom: 25px; color: #05867C;">
                        <i class="fas fa-history" style="margin-right: 10px;"></i>
                        Payment History for ${ownerName}
                    </h2>
                    <span class="close">&times;</span>
                    
                    <div id="payment-history-list" style="max-height: 400px; overflow-y: auto; margin-bottom: 20px; padding: 0 5px;">
                        <!-- Payment history will be loaded here -->
                        <div style="text-align: center; padding: 20px;">
                            <i class="fas fa-spinner fa-spin" style="font-size: 24px; color: #05867C;"></i>
                            <p>Loading payment history...</p>
                        </div>
                    </div>
                    
                    <div class="form-buttons">
                        <button class="action-button close-btn" style="background-color: #94a3b8;">Close</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);

            // Close functionality
            const closeBtn = modal.querySelector('.close');
            const cancelBtn = modal.querySelector('.close-btn');
            
            function closeModal() {
                modal.remove();
            }
            
            closeBtn.onclick = closeModal;
            cancelBtn.onclick = closeModal;
            
            // Close when clicking outside
            window.onclick = function(event) {
                if (event.target == modal) {
                    closeModal();
                }
            }

            // Load payment history
            try {
                // Get all visits for this customer based on email and owner name
                const visitsRef = collection(db, "Customers");
                const q = query(visitsRef, 
                       where("email", "==", email),
                       where("owners", "==", ownerName));
                
                const querySnapshot = await getDocs(q);
                
                const historyList = document.getElementById('payment-history-list');
                historyList.innerHTML = '';
                
                if (querySnapshot.empty) {
                    historyList.innerHTML = `
                        <div style="text-align: center; padding: 20px;">
                            <i class="fas fa-receipt" style="font-size: 24px; color: #cbd5e1;"></i>
                            <p>No payment history found</p>
                        </div>
                    `;
                    return;
                }

                // Sort payments by date
                const payments = [];
                querySnapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.status === 'paid') {
                        payments.push({
                            id: doc.id,
                            ...data
                        });
                    }
                });

                payments.sort((a, b) => b.paidAt.toDate() - a.paidAt.toDate());
                
                payments.forEach(payment => {
                    const paymentDate = payment.paidAt.toDate().toLocaleDateString();
                    const statusClass = payment.medicalCondition === 'Grave' ? 'grave' : 'normal';
                    
                    const paymentItem = document.createElement('div');
                    paymentItem.style.cssText = `
                        border-left: 3px solid #05867C;
                        border-radius: 8px;
                        padding: 15px;
                        margin-bottom: 15px;
                        background-color: #f8f9fa;
                        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
                    `;
                    
                    paymentItem.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <div style="font-weight: 500; color: #05867C;">
                                <i class="fas fa-calendar-day" style="margin-right: 8px;"></i>
                                ${paymentDate}
                            </div>
                            <span class="status-badge ${statusClass}">${payment.medicalCondition}</span>
                        </div>
                        <div style="background-color: white; padding: 10px; border-radius: 6px; margin-top: 10px;">
                            <div style="display: flex; align-items: center; margin-bottom: 5px;">
                                <div style="width: 100px; color: #64748b;">
                                    <i class="fas fa-briefcase-medical" style="margin-right: 8px;"></i>
                                    Service:
                                </div>
                                <div style="font-weight: 500;">${payment.serviceType || 'N/A'}</div>
                            </div>
                            <div style="display: flex; align-items: center; margin-bottom: 5px;">
                                <div style="width: 100px; color: #64748b;">
                                    <i class="fas fa-money-bill" style="margin-right: 8px;"></i>
                                    Amount:
                                </div>
                                <div style="font-weight: 500;">${payment.amount ? payment.amount.toLocaleString() + ' DZD' : 'N/A'}</div>
                            </div>
                            <div style="display: flex; align-items: center;">
                                <div style="width: 100px; color: #64748b;">
                                    <i class="fas fa-money-check" style="margin-right: 8px;"></i>
                                    Method:
                                </div>
                                <div style="font-weight: 500;">${payment.paymentMethod || 'N/A'}</div>
                            </div>
                        </div>
                    `;

                    historyList.appendChild(paymentItem);
                });
            } catch (error) {
                console.error("Error loading payment history:", error);
                document.getElementById('payment-history-list').innerHTML = `
                    <div style="text-align: center; padding: 20px;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 24px; color: #dc3545;"></i>
                        <p>Error loading payment history: ${error.message}</p>
                    </div>
                `;
            }
        }

        async function showReceiptModal(data) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            
            const formattedDate = new Date(data.paidAt.toDate()).toLocaleDateString();
            const formattedTime = new Date(data.paidAt.toDate()).toLocaleTimeString();
            
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 400px;">
                    <div id="receipt-content">
                        <div style="text-align: center; margin-bottom: 20px;">
                            <img src="/logo.webp" alt="Logo" style="width: 120px; margin-bottom: 10px;">
                            <h2 style="color: #05867C; margin: 10px 0;">Payment Receipt</h2>
                            <div style="color: #64748b; font-size: 0.9rem;">Receipt generated on ${formattedDate} at ${formattedTime}</div>
                        </div>
                        
                        <div style="border-top: 1px solid #e2e8f0; border-bottom: 1px solid #e2e8f0; padding: 15px 0; margin: 15px 0;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                <div style="color: #64748b;">
                                    Owner:
                                </div>
                                <div style="font-weight: 500;">${data.owners}</div>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                <div style="color: #64748b;">
                                    Pet:
                                </div>
                                <div style="font-weight: 500;">${data.pets}</div>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                <div style="color: #64748b;">
                                    Service:
                                </div>
                                <div style="font-weight: 500;">${data.serviceType}</div>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                <div style="color: #64748b;">
                                    Date:
                                </div>
                                <div style="font-weight: 500;">${data.date}</div>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                <div style="color: #64748b;">
                                    Time:
                                </div>
                                <div style="font-weight: 500;">${data.time}</div>
                            </div>
                        </div>
                        
                        <div style="background-color: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div style="font-weight: 600; color: #05867C;">
                                    Total Amount:
                                </div>
                                <div style="font-weight: 600; font-size: 1.2rem; color: #05867C;">${data.amount.toLocaleString()} DZD</div>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-top: 10px;">
                                <div style="color: #64748b;">
                                    Payment Method:
                                </div>
                                <div style="font-weight: 500;">${data.paymentMethod}</div>
                            </div>
                        </div>
                        
                        <div style="text-align: center; color: #64748b; font-size: 0.8rem; margin-top: 20px;">
                            Thank you for choosing our services!
                        </div>
                    </div>
                    
                    <div class="form-buttons" style="margin-top: 20px;">
                        <button class="action-button close-btn" style="background-color: #94a3b8;">Close</button>
                        <button class="action-button save-btn" onclick="printReceipt('receipt-content')">
                            <i class="fas fa-print"></i> Print Receipt
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Close functionality
            const closeBtn = modal.querySelector('.close-btn');
            closeBtn.onclick = () => modal.remove();
            
            // Close when clicking outside
            window.onclick = function(event) {
                if (event.target == modal) {
                    modal.remove();
                }
            }
        }

        function printReceipt(elementId) {
            const content = document.getElementById(elementId);
            const originalContents = document.body.innerHTML;
            
            document.body.innerHTML = content.innerHTML;
            
            window.print();
            
            document.body.innerHTML = originalContents;
            
            // Reinitialize event listeners after restoring content
            initializeEventListeners();
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Add click handlers for sidebar navigation
            document.querySelectorAll('.sidebar a').forEach(link => {
                link.addEventListener('click', async (e) => {
                    e.preventDefault();
                    showLoading();
                    const section = e.currentTarget.dataset.section;
                    
                    // Remove active class from all links
                    document.querySelectorAll('.sidebar a').forEach(l => {
                        l.classList.remove('active');
                    });
                    
                    // Add active class to clicked link 
                    e.currentTarget.classList.add('active');
                    
                    document.querySelectorAll('.content-section').forEach(sec => {
                        sec.style.display = 'none';
                    });
                    
                    const sectionElement = document.getElementById(section + '-content');
                    if (sectionElement) {
                        sectionElement.style.display = 'block';
                        if (section === 'veterinarians') {
                            if (auth.currentUser && auth.currentUser.uid) {
                                const clinicsRef = collection(db, "Clinics");
                                const clinicSnapshot = await getDocs(query(clinicsRef, where("uid", "==", auth.currentUser.uid)));
                                const isClinic = !clinicSnapshot.empty;
                                if (isClinic) {
                                    loadClinicVeterinarians();
                                } else {
                                    loadVeterinarians();
                                }
                            } else {
                                hideLoading();
                            }
                        } else if (section === 'schedule') {
                            document.getElementById('dateRange').value = 'week';
                            changeDateRange('week');
                            hideLoading();
                        } else if (section === 'customers') {
                            loadCustomers();
                        } else if (section === 'payment') {
                            loadPayments();
                        } else if (section === 'forms') {
                            loadForms();
                        } else if (section === 'settings') {
                            loadSettingsInfo();
                        } else {
                            hideLoading();
                        }
                    } else {
                        hideLoading();
                    }
                });
            });

            // Add click handlers for export buttons
            document.querySelectorAll('.action-button').forEach(button => {
                if (button.textContent.includes('Export')) {
                    button.onclick = () => window.print();
                }
            });

            const searchInput = document.querySelector('.search-input');
            if (searchInput) {
                // Add input event with debouncing
                let debounceTimer;
                searchInput.addEventListener('input', function() {
                    clearTimeout(debounceTimer);
                    debounceTimer = setTimeout(() => {
                        loadClinicVeterinarians(this.value);
                    }, 300); // Wait 300ms after user stops typing
                });
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            // Add form button click handler
            const addFormBtn = document.getElementById('add-form-btn');
            if (addFormBtn) {
                addFormBtn.addEventListener('click', showNewFormModal);
            }

            // Add customer button click handler
            const addCustomerBtn = document.getElementById('add-customer-btn');
            if (addCustomerBtn) {
                addCustomerBtn.addEventListener('click', showFormSelectionModal);
            }

            // Forms search functionality
            const formsSearchInput = document.querySelector('#forms-content .search-input');
            if (formsSearchInput) {
                let debounceTimer;
                formsSearchInput.addEventListener('input', function() {
                    clearTimeout(debounceTimer);
                    debounceTimer = setTimeout(() => {
                        loadForms(this.value);
                    }, 300);
                });
            }

            // Customers search functionality
            const customersSearchInput = document.querySelector('#customers-content .search-input');
            if (customersSearchInput) {
                let debounceTimer;
                customersSearchInput.addEventListener('input', function() {
                    clearTimeout(debounceTimer);
                    debounceTimer = setTimeout(() => {
                        loadCustomers(this.value);
                    }, 300);
                });
            }

            // Initial load of forms
            const formsSection = document.getElementById('forms-content');
            if (formsSection && formsSection.style.display !== 'none') {
                loadForms();
            }
        });
        
        document.getElementById('logout-btn').addEventListener('click', async () => {
            showLoading();
            try {
                await logOut();
                window.location.href = 'index.html';
            } catch (error) {
                console.error("Error logging out:", error);
                alert(error.message);
                hideLoading();
            }
        });
        
        document.addEventListener('DOMContentLoaded', () => {
            // Payments search functionality
            const paymentsSearchInput = document.querySelector('#payment-content .search-input');
            if (paymentsSearchInput) {
                let debounceTimer;
                paymentsSearchInput.addEventListener('input', function() {
                    clearTimeout(debounceTimer);
                    debounceTimer = setTimeout(() => {
                        loadPayments(this.value);
                    }, 300);
                });
            }
        });
        
        document.addEventListener('DOMContentLoaded', () => {
            let currentDate = new Date();
            let currentView = 'week'; // Default to week view
            
            // Set initial value of dateRange select to 'week'
            document.getElementById('dateRange').value = 'week';
            
            // Generate initial schedule as week view
            generateWeekView(currentDate);
            
            // Update navigation handlers
            document.getElementById('prev-month').addEventListener('click', () => {
                const view = document.getElementById('dateRange').value;
                
                switch(view) {
                    case 'day':
                        currentDate.setDate(currentDate.getDate() - 1);
                        generateWeekView(currentDate);
                        break;
                    case 'week':
                        currentDate.setDate(currentDate.getDate() - 7);
                        generateWeekView(currentDate);
                        break;
                    case 'month':
                        currentDate.setMonth(currentDate.getMonth() - 1);
                        generateSchedule(currentDate.getFullYear(), currentDate.getMonth());
                        break;
                }
                
                updateCurrentMonthDisplay();
            });
            
            document.getElementById('next-month').addEventListener('click', () => {
                const view = document.getElementById('dateRange').value;
                
                switch(view) {
                    case 'day':
                        currentDate.setDate(currentDate.getDate() + 1);
                        generateWeekView(currentDate);
                        break;
                    case 'week':
                        currentDate.setDate(currentDate.getDate() + 7);
                        generateWeekView(currentDate);
                        break;
                    case 'month':
                        currentDate.setMonth(currentDate.getMonth() + 1);
                        generateSchedule(currentDate.getFullYear(), currentDate.getMonth());
                        break;
                }
                
                updateCurrentMonthDisplay();
            });

            function updateCurrentMonthDisplay() {
                const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                                  'July', 'August', 'September', 'October', 'November', 'December'];
                const view = document.getElementById('dateRange').value;
                const displayElement = document.getElementById('current-month');
                
                if (view === 'day') {
                    displayElement.textContent = `${monthNames[currentDate.getMonth()]} ${currentDate.getDate()}, ${currentDate.getFullYear()}`;
                } else if (view === 'week') {
                    const weekStart = new Date(currentDate);
                    weekStart.setDate(currentDate.getDate() - currentDate.getDay());
                    const weekEnd = new Date(weekStart);
                    weekEnd.setDate(weekStart.getDate() + 6);
                    
                    if (weekStart.getMonth() === weekEnd.getMonth()) {
                        displayElement.textContent = `${monthNames[weekStart.getMonth()]} ${weekStart.getDate()}-${weekEnd.getDate()}, ${weekStart.getFullYear()}`;
                    } else {
                        displayElement.textContent = `${monthNames[weekStart.getMonth()]} ${weekStart.getDate()} - ${monthNames[weekEnd.getMonth()]} ${weekEnd.getDate()}`;
                    }
                } else {
                    displayElement.textContent = `${monthNames[currentDate.getMonth()]} ${currentDate.getFullYear()}`;
                }
            }

            // Update the changeDateRange function
            window.changeDateRange = function(range) {
                showLoading();
                currentView = range;
                
                switch(range) {
                    case 'day':
                        generateWeekView(currentDate);
                        break;
                    case 'week':
                        generateWeekView(currentDate);
                        break;
                    case 'month':
                        generateSchedule(currentDate.getFullYear(), currentDate.getMonth());
                        break;
                }
                
                updateCurrentMonthDisplay();
            };
        });

        async function loadDayAppointments(year, month, day, dayCell) {
            if (!auth.currentUser) return;
            
            try {
                const appointmentsRef = collection(db, "appointments");
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const q = query(appointmentsRef, 
                       where("locationEmail", "==", auth.currentUser.email),
                       where("date", "==", dateStr));
                
                const querySnapshot = await getDocs(q);
                
                if (querySnapshot.empty) {
                    return;
                }
                
                // Count normal and grave appointments
                let normalCount = 0;
                let graveCount = 0;
                
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    if (data.medicalCondition === 'Grave') {
                        graveCount++;
                    } else {
                        normalCount++;
                    }
                });
                
                // Add appointment counts if there are any
                if (normalCount > 0 || graveCount > 0) {
                    const countsDiv = document.createElement('div');
                    countsDiv.className = 'appointment-counts';
                    countsDiv.innerHTML = `
                        ${!normalCount ? '' : `<span class="status-badge normal">${normalCount} normal</span>`}
                        ${!graveCount ? '' : `<span class="status-badge grave">${graveCount} grave</span>`}
                    `;
                    dayCell.insertBefore(countsDiv, dayCell.firstChild.nextSibling);
                }
            } catch (error) {
                console.error("Error loading appointments:", error);
            }
        }

        function generateSchedule(year, month) {
            showLoading();
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startingDay = firstDay.getDay();
            const totalDays = lastDay.getDate();
            
            const scheduleGrid = document.getElementById('schedule-grid');
            scheduleGrid.innerHTML = '';
            
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                               'July', 'August', 'September', 'October', 'November', 'December'];
            document.getElementById('current-month').textContent = `${monthNames[month]} ${year}`;
            
            // Add empty cells
            for (let i = 0; i < startingDay; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.className = 'schedule-day';
                scheduleGrid.appendChild(emptyDay);
            }
            
            // Create cells for each day with immediate loading of appointment counts
            const loadingPromises = [];
            for (let day = 1; day <= totalDays; day++) {
                const dayCell = document.createElement('div');
                dayCell.className = 'schedule-day';
                dayCell.setAttribute('data-date', `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`);
                
                // Check if today
                const currentDate = new Date();
                if (year === currentDate.getFullYear() && 
                    month === currentDate.getMonth() && 
                    day === currentDate.getDate()) {
                    dayCell.classList.add('today');
                }
                
                const dateDiv = document.createElement('div');
                dateDiv.className = 'date';
                dateDiv.textContent = day;
                dayCell.appendChild(dateDiv);
                
                const loadPromise = loadDayAppointments(year, month, day, dayCell);
                loadingPromises.push(loadPromise);
                
                // Add click handler for day details
                dayCell.addEventListener('click', function() {
                    const dateStr = this.getAttribute('data-date');
                    showDaySchedule(dateStr);
                });
                
                scheduleGrid.appendChild(dayCell);
            }
            
            // Wait for all appointments to load before hiding loading indicator
            Promise.all(loadingPromises).then(() => {
                hideLoading();
            });
        }

        function generateWeekView(date) {
            showLoading();
            const scheduleGrid = document.getElementById('schedule-grid');
            scheduleGrid.innerHTML = '';
            
            const firstDayOfWeek = new Date(date);
            firstDayOfWeek.setDate(date.getDate() - date.getDay());
            
            const loadingPromises = [];
            for (let i = 0; i < 7; i++) {
                const currentDate = new Date(firstDayOfWeek);
                currentDate.setDate(firstDayOfWeek.getDate() + i);
                
                const dayCell = document.createElement('div');
                dayCell.className = 'schedule-day calendar-day in-range';
                dayCell.setAttribute('data-date', `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}-${String(currentDate.getDate()).padStart(2, '0')}`);
                
                if (currentDate.getDate() === date.getDate()) {
                    dayCell.classList.add('selected');
                }
                
                const dateDiv = document.createElement('div');
                dateDiv.className = 'date';
                dateDiv.textContent = currentDate.getDate();
                dayCell.appendChild(dateDiv);
                
                // Add click handler for day details
                dayCell.addEventListener('click', function() {
                    const dateStr = this.getAttribute('data-date');
                    showDaySchedule(dateStr);
                });
                
                const loadPromise = loadDayAppointments(currentDate.getFullYear(), currentDate.getMonth(), currentDate.getDate(), dayCell);
                loadingPromises.push(loadPromise);
                
                scheduleGrid.appendChild(dayCell);
            }
            
            // Wait for all appointments to load before hiding loading indicator
            Promise.all(loadingPromises).then(() => {
                hideLoading();
            });
        }

        function generateYearView(year) {
            const scheduleGrid = document.getElementById('schedule-grid');
            scheduleGrid.innerHTML = '';
            
            for (let month = 0; month < 12; month++) {
                const monthCell = document.createElement('div');
                monthCell.className = 'schedule-month calendar-day in-range';
                
                const monthName = new Date(year, month).toLocaleString('default', { month: 'long' });
                const monthHeader = document.createElement('div');
                monthHeader.className = 'month-header';
                monthHeader.textContent = monthName;
                monthCell.appendChild(monthHeader);
                
                // Add a simplified calendar for each month
                generateSimplifiedMonthCalendar(year, month, monthCell);
                scheduleGrid.appendChild(monthCell);
            }
        }

        function generateSimplifiedMonthCalendar(year, month, container) {
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const days = lastDay.getDate();
            
            const miniGrid = document.createElement('div');
            miniGrid.className = 'mini-month-grid';
            
            for (let i = 0; i < days; i++) {
                const dayDiv = document.createElement('div');
                dayDiv.className = 'mini-day';
                dayDiv.textContent = i + 1;
                miniGrid.appendChild(dayDiv);
            }
            
            container.appendChild(miniGrid);
        }
        async function loadSettingsInfo() {
            showLoading();
            if (!auth.currentUser) {
                hideLoading();
                return;
            }

            try {
                // Check both Veterinarians and Clinics collections
                const veterinariansRef = collection(db, "Veterinarians");
                const clinicsRef = collection(db, "Clinics");

                const [vetSnapshot, clinicSnapshot] = await Promise.all([
                    getDocs(query(veterinariansRef, where("uid", "==", auth.currentUser.uid))),
                    getDocs(query(clinicsRef, where("uid", "==", auth.currentUser.uid)))
                ]);

                let userData;
                let accountType;

                if (!vetSnapshot.empty) {
                    userData = vetSnapshot.docs[0].data();
                    accountType = 'Veterinarian';
                } else if (!clinicSnapshot.empty) {
                    userData = clinicSnapshot.docs[0].data();
                    accountType = 'Clinic';
                }

                if (userData) {
                    // Update account type
                    document.getElementById('account-type').textContent = accountType;
                    
                    // Update common fields
                    document.getElementById('account-name').textContent = userData.name || 'Not set';
                    document.getElementById('account-email').textContent = userData.email || 'Not set';
                    document.getElementById('account-phone').textContent = userData.phone || userData.phoneNumber || 'Not set';
                    document.getElementById('account-address').textContent = userData.address || 'Not set';
                    document.getElementById('account-working-days').textContent = userData.workingDays || 'Not set';
                    
                    // Format working hours
                    const startTime = userData.startTime || userData.workStartTime || 'Not set';
                    const endTime = userData.endTime || userData.workEndTime || 'Not set';
                    document.getElementById('account-hours').textContent = `${startTime} - ${endTime}`;

                    // Handle specialty field (only for veterinarians)
                    const specialtyField = document.getElementById('specialty-field');
                    const accountSpecialty = document.getElementById('account-specialty');
                    
                    if (accountType === 'Veterinarian' && userData.specialty) {
                        specialtyField.style.display = 'block';
                        accountSpecialty.textContent = userData.specialty;
                    } else {
                        specialtyField.style.display = 'none';
                    }

                    // Update notification toggles based on user preferences
                    document.getElementById('email-notifications').checked = userData.emailNotifications || false;
                    document.getElementById('sms-notifications').checked = userData.smsNotifications || false;
                }
                hideLoading();
            } catch (error) {
                console.error("Error loading settings:", error);
                showNotification('Error loading settings information', 'error');
                hideLoading();
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Add handler for settings menu item
            const settingsLink = document.querySelector('a[data-section="settings"]');
            if (settingsLink) {
                settingsLink.addEventListener('click', () => {
                    loadSettingsInfo();
                });
            }

            // Add handlers for notification toggles
            ['email-notifications', 'sms-notifications'].forEach(id => {
                const toggle = document.getElementById(id);
                if (toggle) {
                    toggle.addEventListener('change', async (e) => {
                        try {
                            // Determine account type
                            const veterinariansRef = collection(db, "Veterinarians");
                            const clinicsRef = collection(db, "Clinics");
                            
                            const [vetSnapshot, clinicSnapshot] = await Promise.all([
                                getDocs(query(veterinariansRef, where("uid", "==", auth.currentUser.uid))),
                                getDocs(query(clinicsRef, where("uid", "==", auth.currentUser.uid)))
                            ]);

                            let docRef;
                            let docId;

                            if (!vetSnapshot.empty) {
                                docRef = veterinariansRef;
                                docId = vetSnapshot.docs[0].id;
                            } else if (!clinicSnapshot.empty) {
                                docRef = clinicsRef;
                                docId = clinicSnapshot.docs[0].id;
                            }

                            if (docRef && docId) {
                                const updateData = {};
                                updateData[id.replace('-', '')] = e.target.checked;
                                
                                await updateDoc(doc(docRef, docId), updateData);
                                showNotification('Notification preferences updated!');
                            }
                        } catch (error) {
                            console.error("Error updating notification preferences:", error);
                            showNotification('Error updating notification preferences', 'error');
                            // Revert toggle if update failed
                            e.target.checked = !e.target.checked;
                        }
                    });
                }
            });

            // Add handler for edit profile button
            const editProfileBtn = document.querySelector('.edit-profile-btn');
            if (editProfileBtn) {
                editProfileBtn.addEventListener('click', async () => {
                    // Get current user data first
                    try {
                        const veterinariansRef = collection(db, "Veterinarians");
                        const clinicsRef = collection(db, "Clinics");

                        const [vetSnapshot, clinicSnapshot] = await Promise.all([
                            getDocs(query(veterinariansRef, where("uid", "==", auth.currentUser.uid))),
                            getDocs(query(clinicsRef, where("uid", "==", auth.currentUser.uid)))
                        ]);

                        let userData;
                        let accountType;
                        let docRef;
                        let docId;

                        if (!vetSnapshot.empty) {
                            userData = vetSnapshot.docs[0].data();
                            accountType = 'Veterinarian';
                            docRef = veterinariansRef;
                            docId = vetSnapshot.docs[0].id;
                        } else if (!clinicSnapshot.empty) {
                            userData = clinicSnapshot.docs[0].data();
                            accountType = 'Clinic';
                            docRef = clinicsRef;
                            docId = clinicSnapshot.docs[0].id;
                        }

                        if (userData) {
                            showEditProfileModal(userData, accountType, docRef, docId);
                        }
                    } catch (error) {
                        console.error("Error getting user data:", error);
                        showNotification('Error loading user data', 'error');
                    }
                });
            }
        });

        function showEditProfileModal(userData, accountType, docRef, docId) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 500px;">
                    <h2 style="text-align: center; margin-bottom: 20px; color: #05867C;">
                        <i class="fas fa-user-edit"></i> Edit Profile
                    </h2>
                    <span class="close">&times;</span>

                    <form id="edit-profile-form">
                        <div class="form-group">
                            <label>Name</label>
                            <div class="input-icon">
                                <i class="fas fa-user"></i>
                                <input type="text" name="name" value="${userData.name || ''}" required>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Phone</label>
                            <div class="input-icon">
                                <i class="fas fa-phone"></i>
                                <input type="tel" name="phone" value="${userData.phone || ''}" required>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Address</label>
                            <div class="input-icon">
                                <i class="fas fa-map-marker-alt"></i>
                                <input type="text" name="address" value="${userData.address || ''}" required>
                            </div>
                        </div>

                        ${accountType === 'Veterinarian' ? `
                            <div class="form-group">
                                <label>Specialty</label>
                                <div class="input-icon">
                                    <i class="fas fa-stethoscope"></i>
                                    <select name="specialty" required>
                                        <option value="General Practice" ${userData.specialty === 'General Practice' ? 'selected' : ''}>General Practice</option>
                                        <option value="Surgery" ${userData.specialty === 'Surgery' ? 'selected' : ''}>Surgery</option>
                                        <option value="Dermatology" ${userData.specialty === 'Dermatology' ? 'selected' : ''}>Dermatology</option>
                                        <option value="Cardiology" ${userData.specialty === 'Cardiology' ? 'selected' : ''}>Cardiology</option>
                                        <option value="Emergency Care" ${userData.specialty === 'Emergency Care' ? 'selected' : ''}>Emergency Care</option>
                                    </select>
                                </div>
                            </div>
                        ` : ''}
                        
                        <div class="form-group">
                            <label>Working Hours</label>
                            <div style="display: flex; gap: 10px;">
                                <div class="input-icon" style="flex: 1;">
                                    <i class="fas fa-clock"></i>
                                    <input type="time" name="startTime" value="${userData.startTime || ''}" required>
                                </div>
                                <div class="input-icon" style="flex: 1;">
                                    <i class="fas fa-clock"></i>
                                    <input type="time" name="endTime" value="${userData.endTime || ''}" required>
                                </div>
                            </div>
                        </div>

                        <div class="form-buttons">
                            <button type="button" class="action-button close-btn" style="background-color: #94a3b8;">Cancel</button>
                            <button type="submit" class="action-button save-btn">
                                <i class="fas fa-save"></i> Save Changes
                            </button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);

            // Close functionality
            const closeBtn = modal.querySelector('.close');
            const cancelBtn = modal.querySelector('.close-btn');
            
            function closeModal() {
                modal.remove();
            }
            
            closeBtn.onclick = closeModal;
            cancelBtn.onclick = closeModal;

            // Form submission
            const form = modal.querySelector('#edit-profile-form');
            form.onsubmit = async (e) => {
                e.preventDefault();
                
                const formData = new FormData(form);
                const updateData = {
                    name: formData.get('name'),
                    phone: formData.get('phone'),
                    address: formData.get('address'),
                    startTime: formData.get('startTime'),
                    endTime: formData.get('endTime')
                };

                if (accountType === 'Veterinarian') {
                    updateData.specialty = formData.get('specialty');
                }

                try {
                    await updateDoc(doc(docRef, docId), updateData);
                    showNotification('Profile updated successfully!');
                    closeModal();
                    loadSettingsInfo();
                } catch (error) {
                    console.error("Error updating profile:", error);
                    showNotification('Error updating profile', 'error');
                }
            };
            
            // Close when clicking outside
            window.onclick = function(event) {
                if (event.target == modal) {
                    closeModal();
                }
            }
        }

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // Check if user is a clinic
                const clinicsRef = collection(db, "Clinics");
                const clinicSnapshot = await getDocs(query(clinicsRef, where("uid", "==", user.uid)));
                const isClinic = !clinicSnapshot.empty;

                // Show/hide veterinarians section based on user type
                const veterinariansMenuItem = document.getElementById('veterinarians-menu-item');
                if (veterinariansMenuItem) {
                    veterinariansMenuItem.style.display = isClinic ? 'block' : 'none';
                }

                // Get veterinarians section
                const veterinariansContent = document.getElementById('veterinarians-content');
                if (veterinariansContent) {
                    veterinariansContent.style.display = 'none';
                }

                // If user is a clinic, show their first available section
                if (!isClinic) {
                    const firstVisibleSection = document.querySelector('.content-section[id^="forms"]');
                    if (firstVisibleSection) {
                        firstVisibleSection.style.display = 'block';
                        if (firstVisibleSection.id === 'forms-content') {
                            loadForms();
                        }
                    }
                    
                    // Hide "Assigned Veterinarian" column in forms table for veterinarians
                    const formsTable = document.querySelector('#forms-content .forms-table');
                    if (formsTable) {
                        // Hide header column
                        const headerCells = formsTable.querySelectorAll('th');
                        if (headerCells && headerCells.length >= 7) {
                            headerCells[6].style.display = 'none';
                        }
                        
                        // Hide data column cells
                        const tableRows = formsTable.querySelectorAll('tbody tr');
                        tableRows.forEach(row => {
                            const cells = row.querySelectorAll('td');
                            if (cells && cells.length >= 7) {
                                cells[6].style.display = 'none';
                            }
                        });
                    }
                }
            }
        });

        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 25px;
                border-radius: 8px;
                color: white;
                font-size: 14px;
                z-index: 1000;
                animation: slideIn 0.5s ease-out;
            `;
            
            notification.style.backgroundColor = type === 'success' ? '#05867C' : '#dc3545';
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.5s ease-in';
                setTimeout(() => notification.remove(), 500);
            }, 3000);
        }

        // Add these CSS keyframes to your existing <style> section or dashboard.css
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);

        document.addEventListener('DOMContentLoaded', () => {
            const addVetBtn = document.getElementById('add-vet-btn');
            if (addVetBtn) {
                addVetBtn.addEventListener('click', showNewClinicVetForm);
            }
        });

        // Update close button color in existing modals
        const modalCloseButtons = document.querySelectorAll('.modal .close-btn');
        modalCloseButtons.forEach(button => button.style.backgroundColor = '#94a3b8');

        function showLoading() {
            document.getElementById('loading-overlay').classList.add('active');
        }
        
        function hideLoading() {
            setTimeout(() => {
                document.getElementById('loading-overlay').classList.remove('active');
            }, 500);
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Revenue Chart
        const ctx = document.getElementById('revenueChart').getContext('2d');
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                datasets: [{
                    label: 'Revenue (DZD)',
                    data: [245000, 286500, 312000, 298000, 356000, 286500],
                    backgroundColor: 'rgba(5, 134, 124, 0.2)',
                    borderColor: '#05867C',
                    borderWidth: 1,
                    borderRadius: 5,
                    barThickness: 25
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            display: true,
                            color: 'rgba(0, 0, 0, 0.05)'
                        },
                        ticks: {
                            callback: function(value) {
                                return value.toLocaleString() + ' DZD';
                            }
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        }
                    }
                }
            }
        });
    </script>
    <script>
        // Conditions Chart
        const conditionsCtx = document.getElementById('conditionsChart').getContext('2d');
        new Chart(conditionsCtx, {
            type: 'doughnut',
            data: {
                labels: ['Vaccinations', 'Injuries', 'Dental', 'Infections', 'Others'],
                datasets: [{
                    data: [35, 25, 20, 15, 5],
                    backgroundColor: [
                        '#05867C',  // Primary teal
                        '#dc3545',  // Red
                        '#3b82f6',  // Blue
                        '#f59e0b',  // Orange
                        '#8b5cf6'   // Purple
                    ],
                    borderWidth: 0,
                    borderRadius: 5
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '65%',
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `${context.label}: ${context.raw}%`;
                            }
                        }
                    }
                }
            }
        });
    </script>
</body>
</html>